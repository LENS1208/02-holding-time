<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FX取引履歴分析ツール - 保有時間分析版</title>
    <style>
        :root {
            /* ダークモードカラーパレット（デフォルト） */
            --bg-primary: #000000;
            --bg-secondary: #181818;
            --bg-tertiary: #232323;
            --bg-border: #373737;
            --color-positive: #00c8ff;
            --color-negative: #ff3200;
            --text-primary: #ffffff;
            --text-secondary: #ffffff;
            --color-neutral: #ffffff;
        }
        
        /* ライトモード */
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #fafafa;
            --bg-tertiary: #f5f5f5;
            --bg-border: #ebebeb;
            --color-positive: #007eff;
            --color-negative: #ff2800;
            --text-primary: #333333;
            --text-secondary: #333333;
            --color-neutral: #333333;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
            background: var(--bg-primary);
            min-height: 100vh; 
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        /* テーマ切り替えボタン */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--bg-border);
            border-radius: 50px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .theme-toggle-icon {
            font-size: 1.2em;
        }
        
        .theme-toggle-text {
            font-size: 0.9em;
            color: var(--text-primary);
        }
        
        [data-theme="light"] .theme-toggle {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="light"] .file-input-wrapper,
        [data-theme="light"] .demo-button {
            box-shadow: 0 2px 8px rgba(0, 126, 255, 0.2);
        }
        
        [data-theme="light"] .upload-section,
        [data-theme="light"] .filter-section,
        [data-theme="light"] .trading-style-section,
        [data-theme="light"] .metric-card,
        [data-theme="light"] .chart-container,
        [data-theme="light"] header {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
            background: var(--bg-primary);
            min-height: 100vh; 
            color: var(--text-primary);
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        header { 
            text-align: center; 
            color: var(--text-primary);
            margin-bottom: 30px; 
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 15px;
            border: 1px solid var(--bg-border);
        }
        
        h1 { 
            font-size: 2.5em; 
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        
        header p {
            color: var(--text-secondary);
        }
        
        .upload-section { 
            background: var(--bg-secondary);
            border-radius: 15px; 
            padding: 30px; 
            border: 1px solid var(--bg-border);
            margin-bottom: 30px; 
        }
        
        .upload-section h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
        }
        
        .demo-button { 
            background: var(--color-positive);
            color: #ffffff;
            padding: 12px 30px; 
            border-radius: 25px; 
            border: none; 
            cursor: pointer; 
            font-size: 1em; 
            margin-left: 20px; 
            transition: opacity 0.2s, transform 0.2s;
        }
        
        .demo-button:hover { 
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .filter-section { 
            background: var(--bg-secondary);
            border-radius: 15px; 
            padding: 20px; 
            margin-bottom: 30px; 
            display: none; 
            border: 1px solid var(--bg-border);
        }
        
        .filter-header { 
            color: var(--text-primary);
            font-size: 1.2em; 
            font-weight: bold; 
            margin-bottom: 20px; 
            padding-bottom: 10px; 
            border-bottom: 2px solid var(--bg-border);
        }
        
        .filter-controls { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 20px; 
            align-items: center; 
        }
        
        .filter-group { 
            display: flex; 
            flex-direction: column; 
        }
        
        .filter-group label { 
            font-size: 0.9em; 
            color: var(--text-secondary);
            margin-bottom: 5px; 
        }
        
        .filter-group select { 
            padding: 8px 12px; 
            border: 1px solid var(--bg-border);
            border-radius: 8px; 
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            min-width: 180px; 
            font-size: 0.95em; 
        }
        
        .file-info { 
            margin-top: 15px; 
            padding: 15px; 
            background: var(--bg-tertiary);
            border-radius: 8px; 
            border-left: 4px solid var(--color-positive);
        }
        
        .file-info h4 { 
            color: var(--text-primary);
            margin-bottom: 8px; 
            font-size: 1em; 
        }
        
        .file-info div { 
            color: var(--text-secondary);
            font-size: 0.9em; 
            line-height: 1.4; 
        }
        
        .file-input-wrapper { 
            position: relative; 
            overflow: hidden; 
            display: inline-block; 
            cursor: pointer; 
            background: var(--color-positive);
            color: #ffffff;
            padding: 12px 30px; 
            border-radius: 25px; 
        }
        
        #fileInput { 
            position: absolute; 
            left: -9999px; 
        }
        
        #fileName {
            margin-top: 10px;
            color: var(--text-secondary);
        }
        
        /* トレードスタイルセクション */
        .trading-style-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--bg-border);
        }
        
        .trading-style-header {
            color: var(--text-primary);
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--bg-border);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-icon {
            font-size: 1.3em;
        }
        
        .trading-style-viz {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .style-viz-container {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--bg-border);
        }
        
        .style-performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        
        .style-perf-card {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid var(--bg-border);
            transition: all 0.3s ease;
        }
        
        .style-perf-card:hover {
            transform: translateY(-2px);
            border-color: var(--color-positive);
        }
        
        .style-perf-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--bg-border);
        }
        
        .style-perf-title {
            font-weight: bold;
            color: var(--text-primary);
            font-size: 1em;
        }
        
        .style-perf-time {
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        
        .style-perf-metrics {
            display: grid;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .style-perf-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }
        
        .style-perf-metric .metric-label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        
        .style-perf-metric .metric-value {
            font-weight: bold;
            font-size: 1em;
        }
        
        .metric-value.positive {
            color: var(--color-positive);
        }
        
        .metric-value.negative {
            color: var(--color-negative);
        }
        
        .metric-value.neutral {
            color: var(--color-neutral);
        }
        
        .style-perf-recommendation {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--bg-border);
            font-size: 0.85em;
            line-height: 1.4;
            color: var(--text-secondary);
        }
        
        .style-perf-recommendation.excellent {
            color: var(--color-positive);
            font-weight: 500;
        }
        
        .style-perf-recommendation.warning {
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .style-perf-recommendation.danger {
            color: var(--color-negative);
            font-weight: 500;
        }
        
        .analysis-section { 
            display: grid; 
            gap: 15px; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            margin-bottom: 30px; 
        }
        
        .metric-card { 
            background: var(--bg-tertiary);
            border-radius: 10px; 
            padding: 15px; 
            border: 1px solid var(--bg-border);
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            border-color: var(--color-positive);
        }
        
        .metric-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--bg-border);
        }
        
        .metric-card-title {
            font-weight: bold;
            color: var(--text-primary);
            font-size: 1em;
        }
        
        .metric-card-subtitle {
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        
        .metric-card-value {
            font-size: 1.8em;
            font-weight: bold;
            text-align: center;
            padding: 20px 0;
        }
        
        .help-icon { 
            cursor: pointer; 
            color: var(--text-secondary);
            font-size: 0.9em; 
            opacity: 0.7; 
            transition: opacity 0.2s; 
        }
        
        .help-icon:hover { 
            opacity: 1; 
        }
        
        .popup-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.8);
            z-index: 1000; 
            display: none; 
            align-items: center; 
            justify-content: center; 
        }
        
        .popup-content { 
            background: var(--bg-secondary);
            border-radius: 12px; 
            padding: 25px; 
            max-width: 400px; 
            margin: 20px; 
            border: 1px solid var(--bg-border);
        }
        
        .popup-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        
        .popup-title { 
            font-size: 1.2em; 
            font-weight: bold; 
            color: var(--text-primary);
        }
        
        .popup-close { 
            cursor: pointer; 
            font-size: 1.5em; 
            color: var(--text-secondary);
            font-weight: bold; 
        }
        
        .popup-close:hover { 
            color: var(--text-primary);
        }
        
        .popup-body { 
            color: var(--text-secondary);
            line-height: 1.6; 
        }
        
        /* サイドパネル用スタイル */
        .side-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1099;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .side-panel-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        
        .side-panel { 
            position: fixed; 
            top: 0; 
            right: -600px; 
            width: 600px; 
            height: 100vh; 
            background: var(--bg-secondary);
            z-index: 1100; 
            transition: right 0.3s ease; 
            overflow-y: auto; 
            border-left: 1px solid var(--bg-border);
        }
        
        .side-panel.open { 
            right: 0; 
        }
        
        .side-panel-header { 
            padding: 20px; 
            border-bottom: 1px solid var(--bg-border);
            background: var(--bg-tertiary);
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
        }
        
        .side-panel-title { 
            font-size: 1.3em; 
            font-weight: bold; 
            color: var(--text-primary);
        }
        
        .side-panel-close { 
            cursor: pointer; 
            font-size: 1.8em; 
            color: var(--text-secondary);
            font-weight: bold; 
        }
        
        .side-panel-close:hover { 
            color: var(--text-primary);
        }
        
        .side-panel-content { 
            padding: 20px; 
        }
        
        .drill-section { 
            margin-bottom: 30px; 
        }
        
        .drill-section h3 { 
            color: var(--text-primary);
            margin-bottom: 15px; 
            font-size: 1.1em; 
            border-bottom: 2px solid var(--bg-border);
            padding-bottom: 8px; 
        }
        
        .drill-stats { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        
        .drill-stat-item { 
            background: var(--bg-tertiary);
            padding: 12px; 
            border-radius: 8px; 
            text-align: center;
            border: 1px solid var(--bg-border);
        }
        
        .drill-stat-value { 
            font-size: 1.2em; 
            font-weight: bold; 
            color: var(--text-primary);
        }
        
        .drill-stat-label { 
            font-size: 0.9em; 
            color: var(--text-secondary);
            margin-top: 4px; 
        }
        
        .drill-insights { 
            background: var(--bg-tertiary);
            border-left: 4px solid var(--color-positive);
            padding: 15px; 
            border-radius: 6px; 
            margin-top: 15px; 
        }
        
        .drill-insights h4 { 
            color: var(--text-primary);
            margin-bottom: 10px; 
            font-size: 1em; 
        }
        
        .drill-insights ul { 
            margin-left: 20px; 
        }
        
        .drill-insights li { 
            margin-bottom: 5px; 
            color: var(--text-secondary);
        }
        
        .metric-value { 
            font-size: 2em; 
            font-weight: bold; 
            margin-bottom: 10px; 
        }
        
        .positive { 
            color: var(--color-positive);
        }
        
        .negative { 
            color: var(--color-negative);
        }
        
        .neutral { 
            color: var(--color-neutral);
        }
        
        .chart-container { 
            background: var(--bg-secondary);
            border-radius: 15px; 
            padding: 25px; 
            margin-top: 20px; 
            border: 1px solid var(--bg-border);
        }
        
        .chart-container h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .error-message { 
            background: rgba(255, 50, 0, 0.1);
            color: var(--color-negative);
            padding: 15px; 
            border-radius: 5px; 
            margin-top: 20px; 
            display: none;
            border: 1px solid rgba(255, 50, 0, 0.3);
        }
        
        .loading { 
            display: none; 
            text-align: center; 
            padding: 20px; 
            color: var(--color-positive);
        }
        
        .spinner { 
            border: 3px solid var(--bg-border);
            border-top: 3px solid var(--color-positive);
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
            margin: 0 auto; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
    </style>
</head>
<body>
    <!-- テーマ切り替えボタン -->
    <button class="theme-toggle" onclick="toggleTheme()">
        <span class="theme-toggle-icon" id="themeIcon">☀️</span>
        <span class="theme-toggle-text" id="themeText">ライトモード</span>
    </button>
    
    <div class="container">
        <header>
            <h1>FX取引履歴分析ツール</h1>
            <p>MT4/MT5の取引履歴(HTML)をアップロードして、保有時間を詳細分析します</p>
        </header>

        <div class="upload-section">
            <h2>取引履歴ファイルをアップロード</h2>
            <div style="display: flex; align-items: center;">
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" accept=".html,.htm" />
                    <label for="fileInput">ファイルを選択</label>
                </div>
                <button class="demo-button" onclick="loadDemoData()">デモデータで試す</button>
            </div>
            <div id="fileName"></div>
            <div id="fileInfo" class="file-info" style="display: none;">
                <h4>取引履歴情報</h4>
                <div id="tradePeriod"></div>
                <div id="tradeCount"></div>
            </div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>分析中...</p>
            </div>
            <div class="error-message" id="errorMessage"></div>
        </div>

        <!-- 保有時間タイプフィルター -->
        <div class="trading-style-section" id="tradingStyleSection" style="display: none;">
            <div class="trading-style-header">
                <span class="section-icon">⏱️</span>
                トレードスタイル別分析
            </div>
            <!-- トレードスタイル可視化 -->
            <div class="trading-style-viz">
                <div class="style-viz-container">
                    <canvas id="styleDistributionChart" height="300"></canvas>
                </div>
                <div class="style-performance-grid">
                    <div class="style-perf-card" id="perfScalping">
                        <div class="style-perf-header">
                            <span class="style-perf-title">スキャルピング</span>
                            <span class="style-perf-time">〜30分</span>
                        </div>
                        <div class="style-perf-metrics">
                            <div class="style-perf-metric">
                                <span class="metric-label">取引数</span>
                                <span class="metric-value" id="countScalping">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">勝率</span>
                                <span class="metric-value" id="winRateScalping">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">期待値(EV)</span>
                                <span class="metric-value" id="evScalping">-</span>
                            </div>
                        </div>
                        <div class="style-perf-recommendation" id="recScalping"></div>
                    </div>
                    
                    <div class="style-perf-card" id="perfDay">
                        <div class="style-perf-header">
                            <span class="style-perf-title">デイトレード</span>
                            <span class="style-perf-time">30分〜4時間</span>
                        </div>
                        <div class="style-perf-metrics">
                            <div class="style-perf-metric">
                                <span class="metric-label">取引数</span>
                                <span class="metric-value" id="countDay">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">勝率</span>
                                <span class="metric-value" id="winRateDay">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">期待値(EV)</span>
                                <span class="metric-value" id="evDay">-</span>
                            </div>
                        </div>
                        <div class="style-perf-recommendation" id="recDay"></div>
                    </div>
                    
                    <div class="style-perf-card" id="perfSwing">
                        <div class="style-perf-header">
                            <span class="style-perf-title">スイング</span>
                            <span class="style-perf-time">4時間〜1日</span>
                        </div>
                        <div class="style-perf-metrics">
                            <div class="style-perf-metric">
                                <span class="metric-label">取引数</span>
                                <span class="metric-value" id="countSwing">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">勝率</span>
                                <span class="metric-value" id="winRateSwing">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">期待値(EV)</span>
                                <span class="metric-value" id="evSwing">-</span>
                            </div>
                        </div>
                        <div class="style-perf-recommendation" id="recSwing"></div>
                    </div>
                    
                    <div class="style-perf-card" id="perfPosition">
                        <div class="style-perf-header">
                            <span class="style-perf-title">ポジション</span>
                            <span class="style-perf-time">1日以上</span>
                        </div>
                        <div class="style-perf-metrics">
                            <div class="style-perf-metric">
                                <span class="metric-label">取引数</span>
                                <span class="metric-value" id="countPosition">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">勝率</span>
                                <span class="metric-value" id="winRatePosition">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">期待値(EV)</span>
                                <span class="metric-value" id="evPosition">-</span>
                            </div>
                        </div>
                        <div class="style-perf-recommendation" id="recPosition"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- フィルターセクション -->
        <div class="filter-section" id="filterSection">
            <div class="filter-header">フィルター設定</div>
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="symbolFilter">通貨ペア</label>
                    <select id="symbolFilter">
                        <option value="all">すべての通貨ペア</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="positionFilter">ロング／ショート</label>
                    <select id="positionFilter">
                        <option value="all">すべてのポジション</option>
                        <option value="buy">ロング（買い）のみ</option>
                        <option value="sell">ショート（売り）のみ</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="weekdayFilter">曜日</label>
                    <select id="weekdayFilter">
                        <option value="all">すべての曜日</option>
                        <option value="1">月曜日</option>
                        <option value="2">火曜日</option>
                        <option value="3">水曜日</option>
                        <option value="4">木曜日</option>
                        <option value="5">金曜日</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="timeFilter">時間帯（日本時間）</label>
                    <select id="timeFilter">
                        <option value="all">すべての時間</option>
                        <option value="morning">朝（6:00-11:59）</option>
                        <option value="afternoon">昼（12:00-17:59）</option>
                        <option value="evening">夜（18:00-23:59）</option>
                        <option value="night">深夜（0:00-5:59）</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="resultFilter">勝敗</label>
                    <select id="resultFilter">
                        <option value="all">すべての取引</option>
                        <option value="win">勝ちトレードのみ</option>
                        <option value="loss">負けトレードのみ</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="analysisRoot"></div>
        
        <!-- ポップアップオーバーレイ -->
        <div class="popup-overlay" id="popupOverlay">
            <div class="popup-content">
                <div class="popup-header">
                    <div class="popup-title" id="popupTitle"></div>
                    <div class="popup-close" id="popupClose">&times;</div>
                </div>
                <div class="popup-body" id="popupBody"></div>
            </div>
        </div>
        
        <!-- サイドパネルオーバーレイ -->
        <div class="side-panel-overlay" id="sidePanelOverlay"></div>
        
        <!-- サイドパネル -->
        <div class="side-panel" id="sidePanel">
            <div class="side-panel-header">
                <div class="side-panel-title" id="sidePanelTitle">保有時間詳細分析</div>
                <div class="side-panel-close" id="sidePanelClose">&times;</div>
            </div>
            <div class="side-panel-content" id="sidePanelContent"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // テーマの初期化と切り替え
        function initTheme() {
            // localStorageが使えない環境でも動作するように
            try {
                const savedTheme = localStorage.getItem('theme') || 'dark';
                document.documentElement.setAttribute('data-theme', savedTheme);
                updateThemeButton(savedTheme);
                updateChartDefaults(savedTheme);
            } catch (e) {
                // localStorageが使えない場合はダークモードをデフォルトに
                document.documentElement.setAttribute('data-theme', 'dark');
                updateThemeButton('dark');
                updateChartDefaults('dark');
            }
        }
        
        window.toggleTheme = function() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            
            try {
                localStorage.setItem('theme', newTheme);
            } catch (e) {
                // localStorageが使えない場合は何もしない
            }
            
            updateThemeButton(newTheme);
            updateChartDefaults(newTheme);
            
            // 既存のチャートを再描画
            if (filteredTrades && filteredTrades.length > 0) {
                renderAnalysis(filteredTrades);
                updateTradingStyleCounts();
            }
        }
        
        function updateThemeButton(theme) {
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            
            if (theme === 'dark') {
                icon.textContent = '☀️';
                text.textContent = 'ライトモード';
            } else {
                icon.textContent = '🌙';
                text.textContent = 'ダークモード';
            }
        }
        
        function updateChartDefaults(theme) {
            if (theme === 'dark') {
                Chart.defaults.color = '#ffffff';
                Chart.defaults.borderColor = '#373737';
                Chart.defaults.plugins.legend.labels.color = '#ffffff';
            } else {
                Chart.defaults.color = '#333333';
                Chart.defaults.borderColor = '#ebebeb';
                Chart.defaults.plugins.legend.labels.color = '#333333';
            }
        }
        
        // ページ読み込み時にテーマを初期化
        document.addEventListener('DOMContentLoaded', initTheme);
        
        // --- グローバル変数 ---
        let allTrades = [];
        let filteredTrades = [];
        let activeCharts = [];
        let currentTradingStyle = 'all';

        // --- DOM要素の取得 ---
        const fileInput = document.getElementById('fileInput');
        const fileNameEl = document.getElementById('fileName');
        const fileInfoEl = document.getElementById('fileInfo');
        const tradePeriodEl = document.getElementById('tradePeriod');
        const tradeCountEl = document.getElementById('tradeCount');
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('errorMessage');
        const analysisRootEl = document.getElementById('analysisRoot');
        const filterSectionEl = document.getElementById('filterSection');
        const tradingStyleSectionEl = document.getElementById('tradingStyleSection');
        const symbolFilterEl = document.getElementById('symbolFilter');
        const positionFilterEl = document.getElementById('positionFilter');
        const weekdayFilterEl = document.getElementById('weekdayFilter');
        const timeFilterEl = document.getElementById('timeFilter');
        const resultFilterEl = document.getElementById('resultFilter');
        const popupOverlay = document.getElementById('popupOverlay');
        const popupTitle = document.getElementById('popupTitle');
        const popupBody = document.getElementById('popupBody');
        const popupClose = document.getElementById('popupClose');
        const sidePanel = document.getElementById('sidePanel');
        const sidePanelTitle = document.getElementById('sidePanelTitle');
        const sidePanelContent = document.getElementById('sidePanelContent');
        const sidePanelClose = document.getElementById('sidePanelClose');
        
        // サイドパネルのオーバーレイ要素を取得
        const sidePanelOverlay = document.getElementById('sidePanelOverlay');

        // --- ヘルプ説明文 ---
        const helpTexts = {
            '総取引数': '分析対象期間内に実行された売買取引の総回数です。',
            '勝率': '利益を出したトレードの割合です。50%以上が目安です。',
            '総損益': '全取引の損益合計です。プラスなら利益、マイナスなら損失です。',
            '勝ちトレード平均保有時間': '利益を出したポジションの平均保有期間です。',
            '負けトレード平均保有時間': '損失を出したポジションの平均保有期間です。',
            '最長保有時間（勝ち）': '勝ちトレードの中で最も長く保有した時間です。',
            '最短保有時間（勝ち）': '勝ちトレードの中で最も短く保有した時間です。',
            '最長保有時間（負け）': '負けトレードの中で最も長く保有した時間です。',
            '最短保有時間（負け）': '負けトレードの中で最も短く保有した時間です。',
            '保有時間分布': '保有時間別の取引回数を表示します。勝ち負け別に色分けされています。'
        };

        // --- イベントリスナー ---
        fileInput.addEventListener('change', handleFileUpload);
        symbolFilterEl.addEventListener('change', applyFilters);
        positionFilterEl.addEventListener('change', applyFilters);
        weekdayFilterEl.addEventListener('change', applyFilters);
        timeFilterEl.addEventListener('change', applyFilters);
        resultFilterEl.addEventListener('change', applyFilters);
        popupClose.addEventListener('click', closePopup);
        popupOverlay.addEventListener('click', (e) => {
            if (e.target === popupOverlay) closePopup();
        });
        sidePanelClose.addEventListener('click', closeSidePanel);
        
        // サイドパネルオーバーレイクリックで閉じる
        sidePanelOverlay.addEventListener('click', function() {
            console.log('Overlay clicked');
            closeSidePanel();
        });
        
        // グローバル関数の定義
        window.loadDemoData = function() {
            console.log('Loading demo data...');
            setLoading(true);
            
            // デモデータを生成
            const demoTrades = generateDemoTrades();
            allTrades = demoTrades;
            filteredTrades = [...allTrades];
            
            fileNameEl.textContent = 'デモデータを使用中';
            displayFileInfo(allTrades);
            populateFilters();
            updateTradingStyleCounts();
            
            // フィルターセクションを確実に表示
            const filterSection = document.getElementById('filterSection');
            if (filterSection) {
                filterSection.style.display = 'block';
                console.log('Filter section displayed');
            }
            
            // トレードスタイルセクションも表示
            tradingStyleSectionEl.style.display = 'block';
            
            renderAnalysis(filteredTrades);
            setLoading(false);
        };
        
        window.showHelp = function(title) {
            popupTitle.textContent = title;
            popupBody.textContent = helpTexts[title] || '説明が見つかりません。';
            popupOverlay.style.display = 'flex';
        };
        
        // トレードスタイルを判定する関数（改良版の時間区分）
        function getTradingStyle(duration) {
            const minutes = duration / (1000 * 60);
            const hours = duration / (1000 * 60 * 60);
            
            if (minutes <= 30) return 'scalping';      // 30分以内
            if (hours <= 4) return 'day';              // 30分〜4時間
            if (hours <= 24) return 'swing';           // 4時間〜1日
            return 'position';                          // 1日以上
        }
        
        // トレードスタイル別のカウントを更新
        function updateTradingStyleCounts() {
            const styleCounts = {
                all: allTrades.length,
                scalping: 0,
                day: 0,
                swing: 0,
                position: 0
            };
            
            const styleStats = {
                scalping: { wins: 0, losses: 0, profit: 0 },
                day: { wins: 0, losses: 0, profit: 0 },
                swing: { wins: 0, losses: 0, profit: 0 },
                position: { wins: 0, losses: 0, profit: 0 }
            };
            
            allTrades.forEach(trade => {
                const style = getTradingStyle(trade.duration);
                styleCounts[style]++;
                
                if (trade.isWin) {
                    styleStats[style].wins++;
                } else {
                    styleStats[style].losses++;
                }
                styleStats[style].profit += trade.profit;
            });
            
            // パフォーマンスカードを更新
            updatePerformanceCards(styleCounts, styleStats);
            
            // 複合チャートを作成
            createStyleComparisonChart(styleCounts, styleStats);
        }
        
        // パフォーマンスカードを更新
        function updatePerformanceCards(styleCounts, styleStats) {
            const styles = ['scalping', 'day', 'swing', 'position'];
            
            styles.forEach(style => {
                const count = styleCounts[style];
                const stats = styleStats[style];
                
                // 取引数
                const countEl = document.getElementById(`count${style.charAt(0).toUpperCase() + style.slice(1)}`);
                countEl.textContent = `${count}回`;
                countEl.className = 'metric-value neutral';
                
                // 勝率
                const winRateEl = document.getElementById(`winRate${style.charAt(0).toUpperCase() + style.slice(1)}`);
                if (count > 0) {
                    const winRate = (stats.wins / count * 100).toFixed(1);
                    winRateEl.textContent = `${winRate}%`;
                    winRateEl.className = `metric-value ${winRate >= 55 ? 'positive' : winRate >= 45 ? 'neutral' : 'negative'}`;
                } else {
                    winRateEl.textContent = '-';
                    winRateEl.className = 'metric-value neutral';
                }
                
                // 期待値（EV）
                const evEl = document.getElementById(`ev${style.charAt(0).toUpperCase() + style.slice(1)}`);
                if (count > 0) {
                    const ev = stats.profit / count;
                    evEl.textContent = `¥${Math.round(ev).toLocaleString()}`;
                    evEl.className = `metric-value ${ev > 0 ? 'positive' : 'negative'}`;
                } else {
                    evEl.textContent = '-';
                    evEl.className = 'metric-value neutral';
                }
                
                // 推奨事項
                const recEl = document.getElementById(`rec${style.charAt(0).toUpperCase() + style.slice(1)}`);
                if (count > 0) {
                    const winRate = stats.wins / count;
                    const ev = stats.profit / count;
                    
                    if (ev > 1000 && winRate >= 0.6) {
                        recEl.textContent = '✨ 優秀！このスタイルが最適です';
                        recEl.className = 'style-perf-recommendation excellent';
                    } else if (ev > 0 && winRate >= 0.5) {
                        recEl.textContent = '📈 良好。継続して改善しましょう';
                        recEl.className = 'style-perf-recommendation';
                    } else if (ev < 0 && count < 10) {
                        recEl.textContent = '⚠️ サンプル数が少ないため評価困難';
                        recEl.className = 'style-perf-recommendation warning';
                    } else if (ev < 0) {
                        recEl.textContent = '🔴 改善が必要。ルールの見直しを';
                        recEl.className = 'style-perf-recommendation danger';
                    } else {
                        recEl.textContent = '📊 さらなる検証が必要です';
                        recEl.className = 'style-perf-recommendation';
                    }
                } else {
                    recEl.textContent = 'データなし';
                    recEl.className = 'style-perf-recommendation';
                }
            });
        }
        
        // 複合チャート（積み上げ棒グラフ＋勝率折れ線）を作成
        function createStyleComparisonChart(styleCounts, styleStats) {
            const ctx = document.getElementById('styleDistributionChart');
            if (!ctx) return;
            
            // 既存のチャートがあれば破棄
            const existingChart = Chart.getChart(ctx);
            if (existingChart) {
                existingChart.destroy();
            }
            
            const labels = ['スキャルピング', 'デイトレード', 'スイング', 'ポジション'];
            const styles = ['scalping', 'day', 'swing', 'position'];
            
            const winData = styles.map(style => styleStats[style].wins);
            const lossData = styles.map(style => styleStats[style].losses);
            const winRates = styles.map(style => {
                const total = styleStats[style].wins + styleStats[style].losses;
                return total > 0 ? (styleStats[style].wins / total * 100) : 0;
            });
            const evData = styles.map(style => {
                const total = styleCounts[style];
                return total > 0 ? Math.round(styleStats[style].profit / total) : 0;
            });
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '勝ちトレード',
                            data: winData,
                            backgroundColor: 'rgba(0, 200, 255, 0.8)',
                            borderColor: '#00c8ff',
                            borderWidth: 1,
                            stack: 'Stack 0'
                        },
                        {
                            label: '負けトレード',
                            data: lossData,
                            backgroundColor: 'rgba(255, 50, 0, 0.8)',
                            borderColor: '#ff3200',
                            borderWidth: 1,
                            stack: 'Stack 0'
                        },
                        {
                            label: '勝率 (%)',
                            data: winRates,
                            type: 'line',
                            borderColor: '#00c8ff',
                            backgroundColor: 'rgba(0, 200, 255, 0.1)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointBackgroundColor: '#00c8ff',
                            yAxisID: 'y1',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'トレードスタイル別パフォーマンス分析',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            color: '#e0e0e0',
                            padding: {
                                bottom: 20
                            }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 11
                                },
                                color: '#e0e0e0'
                            }
                        },
                        tooltip: {
                            backgroundColor: '#181818',
                            borderColor: '#373737',
                            borderWidth: 1,
                            titleColor: '#e0e0e0',
                            bodyColor: '#aaa',
                            callbacks: {
                                afterLabel: function(context) {
                                    if (context.datasetIndex < 2) {
                                        const index = context.dataIndex;
                                        const ev = evData[index];
                                        return `期待値: ¥${ev.toLocaleString()}`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'トレードスタイル',
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#ffffff' 
                                    : '#333333'
                            },
                            grid: {
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#373737' 
                                    : '#ebebeb'
                            },
                            ticks: {
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#ffffff' 
                                    : '#333333'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '取引回数',
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#ffffff' 
                                    : '#333333'
                            },
                            beginAtZero: true,
                            grid: {
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#373737' 
                                    : '#ebebeb'
                            },
                            ticks: {
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#ffffff' 
                                    : '#333333'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '勝率 (%)',
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#ffffff' 
                                    : '#333333'
                            },
                            min: 0,
                            max: 100,
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#ffffff' 
                                    : '#333333'
                            }
                        }
                    }
                }
            });
        }
        
        function generateDemoTrades() {
            const trades = [];
            const symbols = ['USDJPY', 'EURUSD', 'GBPUSD', 'AUDUSD', 'EURJPY'];
            const baseDate = new Date(2024, 0, 1); // 2024年1月1日から
            
            for (let i = 0; i < 100; i++) {
                const openTime = new Date(baseDate.getTime() + Math.random() * 90 * 24 * 60 * 60 * 1000); // 90日間のランダム
                const duration = Math.random() * 48 * 60 * 60 * 1000; // 最大48時間
                const closeTime = new Date(openTime.getTime() + duration);
                const isWin = Math.random() > 0.45; // 勝率55%
                const profit = isWin ? 
                    (Math.random() * 50000 + 5000) : // 勝ち: 5,000-55,000円
                    -(Math.random() * 30000 + 5000);  // 負け: -5,000--35,000円
                
                trades.push({
                    ticket: `#${100000 + i}`,
                    openTime: openTime,
                    closeTime: closeTime,
                    type: Math.random() > 0.5 ? 'buy' : 'sell',
                    size: 0.1,
                    symbol: symbols[Math.floor(Math.random() * symbols.length)],
                    profit: profit,
                    isWin: isWin,
                    duration: duration
                });
            }
            
            return trades.sort((a, b) => a.openTime.getTime() - b.openTime.getTime());
        }
        
        function populateFilters() {
            // 通貨ペアフィルター
            const symbols = [...new Set(allTrades.map(t => t.symbol))];
            symbolFilterEl.innerHTML = '<option value="all">すべての通貨ペア</option>';
            symbols.sort().forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                symbolFilterEl.appendChild(option);
            });
        }
        
        function applyFilters() {
            if (!allTrades || allTrades.length === 0) {
                console.log('No trades to filter');
                return;
            }
            
            filteredTrades = [...allTrades];
            console.log(`Starting with ${filteredTrades.length} trades`);
            
            // 通貨ペアフィルター
            const symbol = symbolFilterEl.value;
            if (symbol !== 'all') {
                filteredTrades = filteredTrades.filter(t => t.symbol === symbol);
                console.log(`After symbol filter: ${filteredTrades.length} trades`);
            }
            
            // ポジションフィルター
            const position = positionFilterEl.value;
            if (position !== 'all') {
                filteredTrades = filteredTrades.filter(t => t.type === position);
                console.log(`After position filter: ${filteredTrades.length} trades`);
            }
            
            // 曜日フィルター
            const weekday = weekdayFilterEl.value;
            if (weekday !== 'all') {
                filteredTrades = filteredTrades.filter(t => t.openTime.getDay() === parseInt(weekday));
                console.log(`After weekday filter: ${filteredTrades.length} trades`);
            }
            
            // 時間帯フィルター
            const timeRange = timeFilterEl.value;
            if (timeRange !== 'all') {
                filteredTrades = filteredTrades.filter(t => {
                    const hour = t.openTime.getHours();
                    switch(timeRange) {
                        case 'morning': return hour >= 6 && hour < 12;
                        case 'afternoon': return hour >= 12 && hour < 18;
                        case 'evening': return hour >= 18 && hour < 24;
                        case 'night': return hour >= 0 && hour < 6;
                        default: return true;
                    }
                });
                console.log(`After time filter: ${filteredTrades.length} trades`);
            }
            
            // 勝敗フィルター
            const result = resultFilterEl.value;
            if (result === 'win') {
                filteredTrades = filteredTrades.filter(t => t.isWin);
                console.log(`After win filter: ${filteredTrades.length} trades`);
            } else if (result === 'loss') {
                filteredTrades = filteredTrades.filter(t => !t.isWin);
                console.log(`After loss filter: ${filteredTrades.length} trades`);
            }
            
            renderAnalysis(filteredTrades);
        }
        
        // --- メインロジック ---
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            resetAnalysisView();
            fileNameEl.textContent = `選択されたファイル: ${file.name}`;
            setLoading(true);

            const reader = new FileReader();
            reader.onload = (e) => parseMT4History(e.target.result);
            reader.readAsText(file, 'UTF-8');
        }

        function parseMT4History(htmlContent) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                const tables = doc.querySelectorAll('table');
                let parsedTrades = [];
                
                tables.forEach(table => {
                    parsedTrades = parsedTrades.concat(parseTableData(table));
                });
                
                if (parsedTrades && parsedTrades.length > 0) {
                    allTrades = parsedTrades.map(trade => ({
                        ...trade,
                        duration: trade.closeTime.getTime() - trade.openTime.getTime()
                    })).sort((a, b) => a.openTime.getTime() - b.openTime.getTime());
                    
                    filteredTrades = [...allTrades];
                    displayFileInfo(allTrades);
                    populateFilters();
                    updateTradingStyleCounts();
                    filterSectionEl.style.display = 'block';
                    tradingStyleSectionEl.style.display = 'block';
                    renderAnalysis(filteredTrades);
                } else {
                    showError('ファイルから取引データが見つかりませんでした。');
                }
            } catch (error) {
                console.error('Parse error:', error);
                showError('ファイルの解析中にエラーが発生しました: ' + error.message);
            } finally {
                setLoading(false);
            }
        }

        function parseTableData(table) {
            const rows = table.querySelectorAll('tr');
            const parsedTrades = [];
            let headerMapping = {};
            let dataStartIndex = -1;
            
            // ヘッダー行を探す
            for (let i = 0; i < Math.min(10, rows.length); i++) {
                const cells = rows[i].querySelectorAll('td, th');
                if (cells.length < 10) continue;
                
                const cellTexts = Array.from(cells).map(cell => cell.textContent.trim().toLowerCase());
                
                if (cellTexts.some(text => text.includes('ticket')) && 
                    cellTexts.some(text => text.includes('time')) && 
                    cellTexts.some(text => text.includes('type'))) {
                    
                    cellTexts.forEach((text, idx) => {
                        if (text.includes('ticket')) headerMapping.ticket = idx;
                        if (text.includes('open time')) headerMapping.openTime = idx;
                        if (text.includes('type')) headerMapping.type = idx;
                        if (text.includes('size') || text.includes('volume')) headerMapping.size = idx;
                        if (text.includes('item') || text.includes('symbol')) headerMapping.symbol = idx;
                        if (text.includes('price') && !headerMapping.openPrice) headerMapping.openPrice = idx;
                        if (text.includes('close time')) headerMapping.closeTime = idx;
                        if (text.includes('profit')) headerMapping.profit = idx;
                    });
                    dataStartIndex = i + 1;
                    break;
                }
            }
            
            if (dataStartIndex === -1) return [];
            
            // データ行を解析
            for (let i = dataStartIndex; i < rows.length; i++) {
                const cells = rows[i].querySelectorAll('td');
                if (cells.length < 10) continue;
                
                const cellTexts = Array.from(cells).map(cell => cell.textContent.trim());
                const type = (cellTexts[headerMapping.type] || '').toLowerCase();
                
                if (type !== 'buy' && type !== 'sell') continue;
                if (!/^\d+$/.test(cellTexts[headerMapping.ticket])) continue;
                
                let profit = 0;
                const profitIndex = headerMapping.profit !== undefined ? headerMapping.profit : cells.length - 1;
                if (cellTexts[profitIndex]) {
                    profit = parseFloat(cellTexts[profitIndex].replace(/[^0-9\.-]/g, ''));
                }
                
                if (isNaN(profit)) continue;
                
                const openTime = parseDateTime(cellTexts[headerMapping.openTime]);
                const closeTime = parseDateTime(cellTexts[headerMapping.closeTime]);
                
                if (!openTime || !closeTime) continue;
                
                parsedTrades.push({
                    ticket: cellTexts[headerMapping.ticket],
                    openTime,
                    closeTime,
                    type,
                    size: parseFloat(cellTexts[headerMapping.size] || '0'),
                    symbol: cellTexts[headerMapping.symbol],
                    profit,
                    isWin: profit > 0
                });
            }
            
            return parsedTrades;
        }
        
        function parseDateTime(dateStr) {
            if (!dateStr) return null;
            const match = dateStr.match(/(\d{4})[./](\d{2})[./](\d{2})\s+(\d{2}):(\d{2})/);
            if (match) {
                const [, year, month, day, hour, minute] = match.map(Number);
                const d = new Date(year, month - 1, day, hour, minute);
                if (!isNaN(d.getTime())) return d;
            }
            return null;
        }

        function displayFileInfo(trades) {
            if (trades.length === 0) return;
            
            const startDate = new Date(Math.min(...trades.map(t => t.openTime.getTime())));
            const endDate = new Date(Math.max(...trades.map(t => t.closeTime.getTime())));
            
            const formatDate = (date) => {
                return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
            };
            
            tradePeriodEl.textContent = `期間: ${formatDate(startDate)} 〜 ${formatDate(endDate)}`;
            tradeCountEl.textContent = `総取引数: ${trades.length}回`;
            fileInfoEl.style.display = 'block';
        }

        function renderAnalysis(trades) {
            resetAnalysisView(true); // フィルターは維持
            
            if (!trades || trades.length === 0) {
                showError("選択された条件に一致する取引データがありません。");
                return;
            }

            console.log(`Rendering analysis for ${trades.length} trades`);
            const stats = calculateStatistics(trades);
            
            analysisRootEl.innerHTML = `
                <!-- 保有時間メトリクス -->
                <div class="analysis-section">
                    <div class="metric-card">
                        <div class="metric-card-header">
                            <span class="metric-card-title">勝ちトレード平均保有時間</span>
                            <span class="help-icon" onclick="showHelp('勝ちトレード平均保有時間')">?</span>
                        </div>
                        <div class="metric-card-value neutral">${formatDuration(stats.avgWinDuration)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-card-header">
                            <span class="metric-card-title">負けトレード平均保有時間</span>
                            <span class="help-icon" onclick="showHelp('負けトレード平均保有時間')">?</span>
                        </div>
                        <div class="metric-card-value neutral">${formatDuration(stats.avgLossDuration)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-card-header">
                            <span class="metric-card-title">最長保有時間（勝ち）</span>
                            <span class="help-icon" onclick="showHelp('最長保有時間（勝ち）')">?</span>
                        </div>
                        <div class="metric-card-value neutral">${formatDuration(stats.maxWinDuration)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-card-header">
                            <span class="metric-card-title">最短保有時間（勝ち）</span>
                            <span class="help-icon" onclick="showHelp('最短保有時間（勝ち）')">?</span>
                        </div>
                        <div class="metric-card-value neutral">${formatDuration(stats.minWinDuration)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-card-header">
                            <span class="metric-card-title">最長保有時間（負け）</span>
                            <span class="help-icon" onclick="showHelp('最長保有時間（負け）')">?</span>
                        </div>
                        <div class="metric-card-value neutral">${formatDuration(stats.maxLossDuration)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-card-header">
                            <span class="metric-card-title">最短保有時間（負け）</span>
                            <span class="help-icon" onclick="showHelp('最短保有時間（負け）')">?</span>
                        </div>
                        <div class="metric-card-value neutral">${formatDuration(stats.minLossDuration)}</div>
                    </div>
                </div>
                
                <!-- 保有時間分布チャート -->
                <div class="chart-container">
                    <h3>保有時間分布<span class="help-icon" onclick="showHelp('保有時間分布')">?</span></h3>
                    <canvas id="durationChart"></canvas>
                </div>
            `;
            
            // チャート作成
            createDurationChart(trades);
        }

        function calculateStatistics(trades) {
            const winTrades = trades.filter(t => t.isWin);
            const lossTrades = trades.filter(t => !t.isWin);
            const totalProfit = trades.reduce((sum, t) => sum + t.profit, 0);
            
            // 保有時間の統計計算
            const winDurations = winTrades.map(t => t.duration);
            const lossDurations = lossTrades.map(t => t.duration);
            
            const avgWinDuration = winDurations.length > 0 ? 
                winDurations.reduce((sum, d) => sum + d, 0) / winDurations.length : 0;
            const avgLossDuration = lossDurations.length > 0 ? 
                lossDurations.reduce((sum, d) => sum + d, 0) / lossDurations.length : 0;
            
            const maxWinDuration = winDurations.length > 0 ? Math.max(...winDurations) : 0;
            const minWinDuration = winDurations.length > 0 ? Math.min(...winDurations) : 0;
            const maxLossDuration = lossDurations.length > 0 ? Math.max(...lossDurations) : 0;
            const minLossDuration = lossDurations.length > 0 ? Math.min(...lossDurations) : 0;
            
            return {
                totalTrades: trades.length,
                winRatePercent: trades.length > 0 ? 
                    (winTrades.length / trades.length * 100).toFixed(1) : "0.0",
                totalProfit,
                avgWinDuration,
                avgLossDuration,
                maxWinDuration,
                minWinDuration,
                maxLossDuration,
                minLossDuration,
                winTrades: winTrades.length,
                lossTrades: lossTrades.length
            };
        }

        function formatDuration(milliseconds) {
            if (!milliseconds || milliseconds === 0) return '0分';
            
            const totalMinutes = Math.floor(milliseconds / (1000 * 60));
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const days = Math.floor(hours / 24);
            const remainingHours = hours % 24;
            
            if (days > 0) {
                return `${days}日${remainingHours}時間${minutes}分`;
            } else if (hours > 0) {
                return `${hours}時間${minutes}分`;
            } else {
                return `${minutes}分`;
            }
        }

        function createDurationChart(trades) {
            const ctx = document.getElementById('durationChart');
            if (!ctx) return;
            
            // 既存のチャートがあれば破棄
            activeCharts.forEach(chart => chart.destroy());
            activeCharts = [];
            
            // 保有時間を範囲別に分類（分単位）
            const ranges = [
                { min: 0, max: 30, label: '〜30分' },
                { min: 30, max: 60, label: '30分〜1時間' },
                { min: 60, max: 180, label: '1〜3時間' },
                { min: 180, max: 360, label: '3〜6時間' },
                { min: 360, max: 720, label: '6〜12時間' },
                { min: 720, max: 1440, label: '12〜24時間' },
                { min: 1440, max: 2880, label: '1〜2日' },
                { min: 2880, max: Infinity, label: '2日以上' }
            ];

            const winDistribution = ranges.map(range => {
                const count = trades.filter(t => {
                    const minutes = t.duration / 60000;
                    return t.isWin && minutes > range.min && minutes <= range.max;
                }).length;
                return count;
            });
            
            const lossDistribution = ranges.map(range => {
                const count = trades.filter(t => {
                    const minutes = t.duration / 60000;
                    return !t.isWin && minutes > range.min && minutes <= range.max;
                }).length;
                return count;
            });

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ranges.map(r => r.label),
                    datasets: [
                        {
                            label: '勝ちトレード',
                            data: winDistribution,
                            backgroundColor: document.documentElement.getAttribute('data-theme') === 'dark' 
                                ? 'rgba(0, 200, 255, 0.8)' 
                                : 'rgba(0, 126, 255, 0.8)',
                            borderColor: document.documentElement.getAttribute('data-theme') === 'dark' 
                                ? '#00c8ff' 
                                : '#007eff',
                            borderWidth: 1
                        },
                        {
                            label: '負けトレード',
                            data: lossDistribution,
                            backgroundColor: document.documentElement.getAttribute('data-theme') === 'dark' 
                                ? 'rgba(255, 50, 0, 0.8)' 
                                : 'rgba(255, 40, 0, 0.8)',
                            borderColor: document.documentElement.getAttribute('data-theme') === 'dark' 
                                ? '#ff3200' 
                                : '#ff2800',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            showDurationDrillDown(ranges[index], trades);
                        }
                    },
                    plugins: {
                        tooltip: {
                            backgroundColor: document.documentElement.getAttribute('data-theme') === 'dark' 
                                ? '#181818' 
                                : '#fafafa',
                            borderColor: document.documentElement.getAttribute('data-theme') === 'dark' 
                                ? '#373737' 
                                : '#ebebeb',
                            borderWidth: 1,
                            titleColor: document.documentElement.getAttribute('data-theme') === 'dark' 
                                ? '#ffffff' 
                                : '#333333',
                            bodyColor: document.documentElement.getAttribute('data-theme') === 'dark' 
                                ? '#ffffff' 
                                : '#333333',
                            callbacks: {
                                afterLabel: function(context) {
                                    return 'クリックで詳細を表示';
                                }
                            }
                        },
                        legend: {
                            labels: {
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#ffffff' 
                                    : '#333333'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { 
                                display: true, 
                                text: '保有時間',
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#ffffff' 
                                    : '#333333'
                            },
                            grid: {
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#373737' 
                                    : '#ebebeb'
                            },
                            ticks: {
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#ffffff' 
                                    : '#333333'
                            }
                        },
                        y: {
                            title: { 
                                display: true, 
                                text: '取引回数',
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#ffffff' 
                                    : '#333333'
                            },
                            beginAtZero: true,
                            grid: {
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#373737' 
                                    : '#ebebeb'
                            },
                            ticks: {
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#ffffff' 
                                    : '#333333'
                            }
                        }
                    }
                }
            });
            
            activeCharts.push(chart);
        }

        function showDurationDrillDown(range, trades) {
            // フィルター適用後のデータから該当する保有時間範囲の取引を抽出
            const filteredRangeTrades = trades.filter(t => {
                const minutes = t.duration / 60000;
                return minutes > range.min && minutes <= range.max;
            });
            
            if (filteredRangeTrades.length === 0) {
                alert('この時間範囲にはデータがありません。');
                return;
            }
            
            const winTrades = filteredRangeTrades.filter(t => t.isWin);
            const lossTrades = filteredRangeTrades.filter(t => !t.isWin);
            const totalProfit = filteredRangeTrades.reduce((sum, t) => sum + t.profit, 0);
            const avgProfit = totalProfit / filteredRangeTrades.length;
            const winRate = (winTrades.length / filteredRangeTrades.length * 100).toFixed(1);
            
            sidePanelTitle.textContent = `保有時間 ${range.label} の詳細分析`;
            
            sidePanelContent.innerHTML = `
                <div class="drill-section">
                    <h3>基本統計</h3>
                    <div class="drill-stats">
                        <div class="drill-stat-item">
                            <div class="drill-stat-value">${filteredRangeTrades.length}回</div>
                            <div class="drill-stat-label">総取引数</div>
                        </div>
                        <div class="drill-stat-item">
                            <div class="drill-stat-value ${winRate >= 50 ? 'positive' : 'negative'}">${winRate}%</div>
                            <div class="drill-stat-label">勝率</div>
                        </div>
                        <div class="drill-stat-item">
                            <div class="drill-stat-value ${totalProfit >= 0 ? 'positive' : 'negative'}">¥${Math.round(totalProfit).toLocaleString()}</div>
                            <div class="drill-stat-label">総損益</div>
                        </div>
                        <div class="drill-stat-item">
                            <div class="drill-stat-value ${avgProfit >= 0 ? 'positive' : 'negative'}">¥${Math.round(avgProfit).toLocaleString()}</div>
                            <div class="drill-stat-label">平均損益</div>
                        </div>
                    </div>
                </div>
                
                <div class="drill-section">
                    <h3>勝ちトレード統計</h3>
                    <div class="drill-stats">
                        <div class="drill-stat-item">
                            <div class="drill-stat-value neutral">${winTrades.length}回</div>
                            <div class="drill-stat-label">取引回数</div>
                        </div>
                        <div class="drill-stat-item">
                            <div class="drill-stat-value positive">¥${winTrades.length > 0 ? Math.round(winTrades.reduce((sum, t) => sum + t.profit, 0) / winTrades.length).toLocaleString() : 0}</div>
                            <div class="drill-stat-label">平均利益</div>
                        </div>
                    </div>
                </div>
                
                <div class="drill-section">
                    <h3>負けトレード統計</h3>
                    <div class="drill-stats">
                        <div class="drill-stat-item">
                            <div class="drill-stat-value neutral">${lossTrades.length}回</div>
                            <div class="drill-stat-label">取引回数</div>
                        </div>
                        <div class="drill-stat-item">
                            <div class="drill-stat-value negative">¥${lossTrades.length > 0 ? Math.abs(Math.round(lossTrades.reduce((sum, t) => sum + t.profit, 0) / lossTrades.length)).toLocaleString() : 0}</div>
                            <div class="drill-stat-label">平均損失</div>
                        </div>
                    </div>
                </div>
                
                <div class="drill-section">
                    <h3>分析と推奨事項</h3>
                    <div class="drill-insights">
                        <h4>パフォーマンス評価</h4>
                        <ul>
                            ${generateInsights(range, winRate, avgProfit, filteredRangeTrades)}
                        </ul>
                    </div>
                </div>
            `;
            
            sidePanel.classList.add('open');
            sidePanelOverlay.classList.add('open');
        }

        function generateInsights(range, winRate, avgProfit, trades) {
            let insights = [];
            
            // 保有時間カテゴリーの判定
            if (range.max <= 60) {
                insights.push('<li>この時間帯はスキャルピング取引に該当します。</li>');
                if (parseFloat(winRate) >= 60) {
                    insights.push('<li>高い勝率を維持できています。短期売買戦略が機能しています。</li>');
                } else {
                    insights.push('<li>勝率向上のため、エントリーポイントの精度を高める必要があります。</li>');
                }
            } else if (range.max <= 720) {
                insights.push('<li>この時間帯はデイトレードに該当します。</li>');
                if (avgProfit > 0) {
                    insights.push('<li>日中の値動きを効果的に捉えています。</li>');
                } else {
                    insights.push('<li>損切りタイミングの見直しが必要かもしれません。</li>');
                }
            } else {
                insights.push('<li>この時間帯はスイング/ポジショントレードに該当します。</li>');
                if (avgProfit > 0) {
                    insights.push('<li>長期保有戦略が利益を生んでいます。</li>');
                } else {
                    insights.push('<li>長期保有のリスク管理を強化する必要があります。</li>');
                }
            }
            
            // リスクリワード比の評価
            const winTrades = trades.filter(t => t.isWin);
            const lossTrades = trades.filter(t => !t.isWin);
            if (winTrades.length > 0 && lossTrades.length > 0) {
                const avgWin = winTrades.reduce((sum, t) => sum + t.profit, 0) / winTrades.length;
                const avgLoss = Math.abs(lossTrades.reduce((sum, t) => sum + t.profit, 0) / lossTrades.length);
                const riskReward = avgWin / avgLoss;
                
                if (riskReward > 1.5) {
                    insights.push('<li>優れたリスクリワード比を達成しています。</li>');
                } else if (riskReward > 1) {
                    insights.push('<li>リスクリワード比は良好です。</li>');
                } else {
                    insights.push('<li>リスクリワード比の改善が必要です。</li>');
                }
            }
            
            return insights.join('');
        }

        function closeSidePanel() {
            sidePanel.classList.remove('open');
            sidePanelOverlay.classList.remove('open');
        }

        function resetAnalysisView(keepFilters = false) {
            analysisRootEl.innerHTML = '';
            errorEl.style.display = 'none';
            
            if (!keepFilters) {
                fileInfoEl.style.display = 'none';
                filterSectionEl.style.display = 'none';
                tradingStyleSectionEl.style.display = 'none';
                currentTradingStyle = 'all';
            }
            
            activeCharts.forEach(chart => chart.destroy());
            activeCharts = [];
        }

        function setLoading(isLoading) {
            loadingEl.style.display = isLoading ? 'block' : 'none';
        }

        function showError(message) {
            errorEl.style.display = 'block';
            errorEl.textContent = message;
        }

        function closePopup() {
            popupOverlay.style.display = 'none';
        }
    </script>
</body>
</html>
