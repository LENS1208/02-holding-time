<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FXå–å¼•å±¥æ­´åˆ†æãƒ„ãƒ¼ãƒ« - ä¿æœ‰æ™‚é–“åˆ†æç‰ˆ</title>
    <style>
        :root {
            /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ */
            --bg-primary: #000000;
            --bg-secondary: #181818;
            --bg-tertiary: #232323;
            --bg-border: #373737;
            --color-positive: #00c8ff;
            --color-negative: #ff3200;
            --text-primary: #ffffff;
            --text-secondary: #ffffff;
            --color-neutral: #ffffff;
        }
        
        /* ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ */
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #fafafa;
            --bg-tertiary: #f5f5f5;
            --bg-border: #ebebeb;
            --color-positive: #007eff;
            --color-negative: #ff2800;
            --text-primary: #333333;
            --text-secondary: #333333;
            --color-neutral: #333333;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
            background: var(--bg-primary);
            min-height: 100vh; 
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        /* ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--bg-border);
            border-radius: 50px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .theme-toggle-icon {
            font-size: 1.2em;
        }
        
        .theme-toggle-text {
            font-size: 0.9em;
            color: var(--text-primary);
        }
        
        [data-theme="light"] .theme-toggle {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        [data-theme="light"] .file-input-wrapper,
        [data-theme="light"] .demo-button {
            box-shadow: 0 2px 8px rgba(0, 126, 255, 0.2);
        }
        
        [data-theme="light"] .upload-section,
        [data-theme="light"] .filter-section,
        [data-theme="light"] .trading-style-section,
        [data-theme="light"] .metric-card,
        [data-theme="light"] .chart-container,
        [data-theme="light"] header {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; 
            background: var(--bg-primary);
            min-height: 100vh; 
            color: var(--text-primary);
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        header { 
            text-align: center; 
            color: var(--text-primary);
            margin-bottom: 30px; 
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 15px;
            border: 1px solid var(--bg-border);
        }
        
        h1 { 
            font-size: 2.5em; 
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        
        header p {
            color: var(--text-secondary);
        }
        
        .upload-section { 
            background: var(--bg-secondary);
            border-radius: 15px; 
            padding: 30px; 
            border: 1px solid var(--bg-border);
            margin-bottom: 30px; 
        }
        
        .upload-section h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
        }
        
        .demo-button { 
            background: var(--color-positive);
            color: #ffffff;
            padding: 12px 30px; 
            border-radius: 25px; 
            border: none; 
            cursor: pointer; 
            font-size: 1em; 
            margin-left: 20px; 
            transition: opacity 0.2s, transform 0.2s;
        }
        
        .demo-button:hover { 
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .filter-section { 
            background: var(--bg-secondary);
            border-radius: 15px; 
            padding: 20px; 
            margin-bottom: 30px; 
            display: none; 
            border: 1px solid var(--bg-border);
        }
        
        .filter-header { 
            color: var(--text-primary);
            font-size: 1.2em; 
            font-weight: bold; 
            margin-bottom: 20px; 
            padding-bottom: 10px; 
            border-bottom: 2px solid var(--bg-border);
        }
        
        .filter-controls { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 20px; 
            align-items: center; 
        }
        
        .filter-group { 
            display: flex; 
            flex-direction: column; 
        }
        
        .filter-group label { 
            font-size: 0.9em; 
            color: var(--text-secondary);
            margin-bottom: 5px; 
        }
        
        .filter-group select { 
            padding: 8px 12px; 
            border: 1px solid var(--bg-border);
            border-radius: 8px; 
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            min-width: 180px; 
            font-size: 0.95em; 
        }
        
        .file-info { 
            margin-top: 15px; 
            padding: 15px; 
            background: var(--bg-tertiary);
            border-radius: 8px; 
            border-left: 4px solid var(--color-positive);
        }
        
        .file-info h4 { 
            color: var(--text-primary);
            margin-bottom: 8px; 
            font-size: 1em; 
        }
        
        .file-info div { 
            color: var(--text-secondary);
            font-size: 0.9em; 
            line-height: 1.4; 
        }
        
        .file-input-wrapper { 
            position: relative; 
            overflow: hidden; 
            display: inline-block; 
            cursor: pointer; 
            background: var(--color-positive);
            color: #ffffff;
            padding: 12px 30px; 
            border-radius: 25px; 
        }
        
        #fileInput { 
            position: absolute; 
            left: -9999px; 
        }
        
        #fileName {
            margin-top: 10px;
            color: var(--text-secondary);
        }
        
        /* ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .trading-style-section {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--bg-border);
        }
        
        .trading-style-header {
            color: var(--text-primary);
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--bg-border);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-icon {
            font-size: 1.3em;
        }
        
        .trading-style-viz {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .style-viz-container {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--bg-border);
        }
        
        .style-performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        
        .style-perf-card {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid var(--bg-border);
            transition: all 0.3s ease;
        }
        
        .style-perf-card:hover {
            transform: translateY(-2px);
            border-color: var(--color-positive);
        }
        
        .style-perf-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--bg-border);
        }
        
        .style-perf-title {
            font-weight: bold;
            color: var(--text-primary);
            font-size: 1em;
        }
        
        .style-perf-time {
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        
        .style-perf-metrics {
            display: grid;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .style-perf-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }
        
        .style-perf-metric .metric-label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        
        .style-perf-metric .metric-value {
            font-weight: bold;
            font-size: 1em;
        }
        
        .metric-value.positive {
            color: var(--color-positive);
        }
        
        .metric-value.negative {
            color: var(--color-negative);
        }
        
        .metric-value.neutral {
            color: var(--color-neutral);
        }
        
        .style-perf-recommendation {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--bg-border);
            font-size: 0.85em;
            line-height: 1.4;
            color: var(--text-secondary);
        }
        
        .style-perf-recommendation.excellent {
            color: var(--color-positive);
            font-weight: 500;
        }
        
        .style-perf-recommendation.warning {
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .style-perf-recommendation.danger {
            color: var(--color-negative);
            font-weight: 500;
        }
        
        .analysis-section { 
            display: grid; 
            gap: 15px; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            margin-bottom: 30px; 
        }
        
        .metric-card { 
            background: var(--bg-tertiary);
            border-radius: 10px; 
            padding: 15px; 
            border: 1px solid var(--bg-border);
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            border-color: var(--color-positive);
        }
        
        .metric-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--bg-border);
        }
        
        .metric-card-title {
            font-weight: bold;
            color: var(--text-primary);
            font-size: 1em;
        }
        
        .metric-card-subtitle {
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        
        .metric-card-value {
            font-size: 1.8em;
            font-weight: bold;
            text-align: center;
            padding: 20px 0;
        }
        
        .help-icon { 
            cursor: pointer; 
            color: var(--text-secondary);
            font-size: 0.9em; 
            opacity: 0.7; 
            transition: opacity 0.2s; 
        }
        
        .help-icon:hover { 
            opacity: 1; 
        }
        
        .popup-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.8);
            z-index: 1000; 
            display: none; 
            align-items: center; 
            justify-content: center; 
        }
        
        .popup-content { 
            background: var(--bg-secondary);
            border-radius: 12px; 
            padding: 25px; 
            max-width: 400px; 
            margin: 20px; 
            border: 1px solid var(--bg-border);
        }
        
        .popup-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        
        .popup-title { 
            font-size: 1.2em; 
            font-weight: bold; 
            color: var(--text-primary);
        }
        
        .popup-close { 
            cursor: pointer; 
            font-size: 1.5em; 
            color: var(--text-secondary);
            font-weight: bold; 
        }
        
        .popup-close:hover { 
            color: var(--text-primary);
        }
        
        .popup-body { 
            color: var(--text-secondary);
            line-height: 1.6; 
        }
        
        /* ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .side-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1099;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .side-panel-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        
        .side-panel { 
            position: fixed; 
            top: 0; 
            right: -600px; 
            width: 600px; 
            height: 100vh; 
            background: var(--bg-secondary);
            z-index: 1100; 
            transition: right 0.3s ease; 
            overflow-y: auto; 
            border-left: 1px solid var(--bg-border);
        }
        
        .side-panel.open { 
            right: 0; 
        }
        
        .side-panel-header { 
            padding: 20px; 
            border-bottom: 1px solid var(--bg-border);
            background: var(--bg-tertiary);
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
        }
        
        .side-panel-title { 
            font-size: 1.3em; 
            font-weight: bold; 
            color: var(--text-primary);
        }
        
        .side-panel-close { 
            cursor: pointer; 
            font-size: 1.8em; 
            color: var(--text-secondary);
            font-weight: bold; 
        }
        
        .side-panel-close:hover { 
            color: var(--text-primary);
        }
        
        .side-panel-content { 
            padding: 20px; 
        }
        
        .drill-section { 
            margin-bottom: 30px; 
        }
        
        .drill-section h3 { 
            color: var(--text-primary);
            margin-bottom: 15px; 
            font-size: 1.1em; 
            border-bottom: 2px solid var(--bg-border);
            padding-bottom: 8px; 
        }
        
        .drill-stats { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        
        .drill-stat-item { 
            background: var(--bg-tertiary);
            padding: 12px; 
            border-radius: 8px; 
            text-align: center;
            border: 1px solid var(--bg-border);
        }
        
        .drill-stat-value { 
            font-size: 1.2em; 
            font-weight: bold; 
            color: var(--text-primary);
        }
        
        .drill-stat-label { 
            font-size: 0.9em; 
            color: var(--text-secondary);
            margin-top: 4px; 
        }
        
        .drill-insights { 
            background: var(--bg-tertiary);
            border-left: 4px solid var(--color-positive);
            padding: 15px; 
            border-radius: 6px; 
            margin-top: 15px; 
        }
        
        .drill-insights h4 { 
            color: var(--text-primary);
            margin-bottom: 10px; 
            font-size: 1em; 
        }
        
        .drill-insights ul { 
            margin-left: 20px; 
        }
        
        .drill-insights li { 
            margin-bottom: 5px; 
            color: var(--text-secondary);
        }
        
        .metric-value { 
            font-size: 2em; 
            font-weight: bold; 
            margin-bottom: 10px; 
        }
        
        .positive { 
            color: var(--color-positive);
        }
        
        .negative { 
            color: var(--color-negative);
        }
        
        .neutral { 
            color: var(--color-neutral);
        }
        
        .chart-container { 
            background: var(--bg-secondary);
            border-radius: 15px; 
            padding: 25px; 
            margin-top: 20px; 
            border: 1px solid var(--bg-border);
        }
        
        .chart-container h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .error-message { 
            background: rgba(255, 50, 0, 0.1);
            color: var(--color-negative);
            padding: 15px; 
            border-radius: 5px; 
            margin-top: 20px; 
            display: none;
            border: 1px solid rgba(255, 50, 0, 0.3);
        }
        
        .loading { 
            display: none; 
            text-align: center; 
            padding: 20px; 
            color: var(--color-positive);
        }
        
        .spinner { 
            border: 3px solid var(--bg-border);
            border-top: 3px solid var(--color-positive);
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
            margin: 0 auto; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
    </style>
</head>
<body>
    <!-- ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
    <button class="theme-toggle" onclick="toggleTheme()">
        <span class="theme-toggle-icon" id="themeIcon">â˜€ï¸</span>
        <span class="theme-toggle-text" id="themeText">ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰</span>
    </button>
    
    <div class="container">
        <header>
            <h1>FXå–å¼•å±¥æ­´åˆ†æãƒ„ãƒ¼ãƒ«</h1>
            <p>MT4/MT5ã®å–å¼•å±¥æ­´(HTML)ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€ä¿æœ‰æ™‚é–“ã‚’è©³ç´°åˆ†æã—ã¾ã™</p>
        </header>

        <div class="upload-section">
            <h2>å–å¼•å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
            <div style="display: flex; align-items: center;">
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" accept=".html,.htm" />
                    <label for="fileInput">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
                </div>
                <button class="demo-button" onclick="loadDemoData()">ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã§è©¦ã™</button>
            </div>
            <div id="fileName"></div>
            <div id="fileInfo" class="file-info" style="display: none;">
                <h4>å–å¼•å±¥æ­´æƒ…å ±</h4>
                <div id="tradePeriod"></div>
                <div id="tradeCount"></div>
            </div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>åˆ†æä¸­...</p>
            </div>
            <div class="error-message" id="errorMessage"></div>
        </div>

        <!-- ä¿æœ‰æ™‚é–“ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="trading-style-section" id="tradingStyleSection" style="display: none;">
            <div class="trading-style-header">
                <span class="section-icon">â±ï¸</span>
                ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«åˆ¥åˆ†æ
            </div>
            <!-- ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«å¯è¦–åŒ– -->
            <div class="trading-style-viz">
                <div class="style-viz-container">
                    <canvas id="styleDistributionChart" height="300"></canvas>
                </div>
                <div class="style-performance-grid">
                    <div class="style-perf-card" id="perfScalping">
                        <div class="style-perf-header">
                            <span class="style-perf-title">ã‚¹ã‚­ãƒ£ãƒ«ãƒ”ãƒ³ã‚°</span>
                            <span class="style-perf-time">ã€œ30åˆ†</span>
                        </div>
                        <div class="style-perf-metrics">
                            <div class="style-perf-metric">
                                <span class="metric-label">å–å¼•æ•°</span>
                                <span class="metric-value" id="countScalping">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">å‹ç‡</span>
                                <span class="metric-value" id="winRateScalping">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">æœŸå¾…å€¤(EV)</span>
                                <span class="metric-value" id="evScalping">-</span>
                            </div>
                        </div>
                        <div class="style-perf-recommendation" id="recScalping"></div>
                    </div>
                    
                    <div class="style-perf-card" id="perfDay">
                        <div class="style-perf-header">
                            <span class="style-perf-title">ãƒ‡ã‚¤ãƒˆãƒ¬ãƒ¼ãƒ‰</span>
                            <span class="style-perf-time">30åˆ†ã€œ4æ™‚é–“</span>
                        </div>
                        <div class="style-perf-metrics">
                            <div class="style-perf-metric">
                                <span class="metric-label">å–å¼•æ•°</span>
                                <span class="metric-value" id="countDay">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">å‹ç‡</span>
                                <span class="metric-value" id="winRateDay">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">æœŸå¾…å€¤(EV)</span>
                                <span class="metric-value" id="evDay">-</span>
                            </div>
                        </div>
                        <div class="style-perf-recommendation" id="recDay"></div>
                    </div>
                    
                    <div class="style-perf-card" id="perfSwing">
                        <div class="style-perf-header">
                            <span class="style-perf-title">ã‚¹ã‚¤ãƒ³ã‚°</span>
                            <span class="style-perf-time">4æ™‚é–“ã€œ1æ—¥</span>
                        </div>
                        <div class="style-perf-metrics">
                            <div class="style-perf-metric">
                                <span class="metric-label">å–å¼•æ•°</span>
                                <span class="metric-value" id="countSwing">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">å‹ç‡</span>
                                <span class="metric-value" id="winRateSwing">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">æœŸå¾…å€¤(EV)</span>
                                <span class="metric-value" id="evSwing">-</span>
                            </div>
                        </div>
                        <div class="style-perf-recommendation" id="recSwing"></div>
                    </div>
                    
                    <div class="style-perf-card" id="perfPosition">
                        <div class="style-perf-header">
                            <span class="style-perf-title">ãƒã‚¸ã‚·ãƒ§ãƒ³</span>
                            <span class="style-perf-time">1æ—¥ä»¥ä¸Š</span>
                        </div>
                        <div class="style-perf-metrics">
                            <div class="style-perf-metric">
                                <span class="metric-label">å–å¼•æ•°</span>
                                <span class="metric-value" id="countPosition">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">å‹ç‡</span>
                                <span class="metric-value" id="winRatePosition">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">æœŸå¾…å€¤(EV)</span>
                                <span class="metric-value" id="evPosition">-</span>
                            </div>
                        </div>
                        <div class="style-perf-recommendation" id="recPosition"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="filter-section" id="filterSection">
            <div class="filter-header">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š</div>
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="symbolFilter">é€šè²¨ãƒšã‚¢</label>
                    <select id="symbolFilter">
                        <option value="all">ã™ã¹ã¦ã®é€šè²¨ãƒšã‚¢</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="positionFilter">ãƒ­ãƒ³ã‚°ï¼ã‚·ãƒ§ãƒ¼ãƒˆ</label>
                    <select id="positionFilter">
                        <option value="all">ã™ã¹ã¦ã®ãƒã‚¸ã‚·ãƒ§ãƒ³</option>
                        <option value="buy">ãƒ­ãƒ³ã‚°ï¼ˆè²·ã„ï¼‰ã®ã¿</option>
                        <option value="sell">ã‚·ãƒ§ãƒ¼ãƒˆï¼ˆå£²ã‚Šï¼‰ã®ã¿</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="weekdayFilter">æ›œæ—¥</label>
                    <select id="weekdayFilter">
                        <option value="all">ã™ã¹ã¦ã®æ›œæ—¥</option>
                        <option value="1">æœˆæ›œæ—¥</option>
                        <option value="2">ç«æ›œæ—¥</option>
                        <option value="3">æ°´æ›œæ—¥</option>
                        <option value="4">æœ¨æ›œæ—¥</option>
                        <option value="5">é‡‘æ›œæ—¥</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="timeFilter">æ™‚é–“å¸¯ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰</label>
                    <select id="timeFilter">
                        <option value="all">ã™ã¹ã¦ã®æ™‚é–“</option>
                        <option value="morning">æœï¼ˆ6:00-11:59ï¼‰</option>
                        <option value="afternoon">æ˜¼ï¼ˆ12:00-17:59ï¼‰</option>
                        <option value="evening">å¤œï¼ˆ18:00-23:59ï¼‰</option>
                        <option value="night">æ·±å¤œï¼ˆ0:00-5:59ï¼‰</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="resultFilter">å‹æ•—</label>
                    <select id="resultFilter">
                        <option value="all">ã™ã¹ã¦ã®å–å¼•</option>
                        <option value="win">å‹ã¡ãƒˆãƒ¬ãƒ¼ãƒ‰ã®ã¿</option>
                        <option value="loss">è² ã‘ãƒˆãƒ¬ãƒ¼ãƒ‰ã®ã¿</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="analysisRoot"></div>
        
        <!-- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <div class="popup-overlay" id="popupOverlay">
            <div class="popup-content">
                <div class="popup-header">
                    <div class="popup-title" id="popupTitle"></div>
                    <div class="popup-close" id="popupClose">&times;</div>
                </div>
                <div class="popup-body" id="popupBody"></div>
            </div>
        </div>
        
        <!-- ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <div class="side-panel-overlay" id="sidePanelOverlay"></div>
        
        <!-- ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« -->
        <div class="side-panel" id="sidePanel">
            <div class="side-panel-header">
                <div class="side-panel-title" id="sidePanelTitle">ä¿æœ‰æ™‚é–“è©³ç´°åˆ†æ</div>
                <div class="side-panel-close" id="sidePanelClose">&times;</div>
            </div>
            <div class="side-panel-content" id="sidePanelContent"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // ãƒ†ãƒ¼ãƒã®åˆæœŸåŒ–ã¨åˆ‡ã‚Šæ›¿ãˆ
        function initTheme() {
            // localStorageãŒä½¿ãˆãªã„ç’°å¢ƒã§ã‚‚å‹•ä½œã™ã‚‹ã‚ˆã†ã«
            try {
                const savedTheme = localStorage.getItem('theme') || 'dark';
                document.documentElement.setAttribute('data-theme', savedTheme);
                updateThemeButton(savedTheme);
                updateChartDefaults(savedTheme);
            } catch (e) {
                // localStorageãŒä½¿ãˆãªã„å ´åˆã¯ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«
                document.documentElement.setAttribute('data-theme', 'dark');
                updateThemeButton('dark');
                updateChartDefaults('dark');
            }
        }
        
        window.toggleTheme = function() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            
            try {
                localStorage.setItem('theme', newTheme);
            } catch (e) {
                // localStorageãŒä½¿ãˆãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
            }
            
            updateThemeButton(newTheme);
            updateChartDefaults(newTheme);
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’å†æç”»
            if (filteredTrades && filteredTrades.length > 0) {
                renderAnalysis(filteredTrades);
                updateTradingStyleCounts();
            }
        }
        
        function updateThemeButton(theme) {
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            
            if (theme === 'dark') {
                icon.textContent = 'â˜€ï¸';
                text.textContent = 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰';
            } else {
                icon.textContent = 'ğŸŒ™';
                text.textContent = 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰';
            }
        }
        
        function updateChartDefaults(theme) {
            if (theme === 'dark') {
                Chart.defaults.color = '#ffffff';
                Chart.defaults.borderColor = '#373737';
                Chart.defaults.plugins.legend.labels.color = '#ffffff';
            } else {
                Chart.defaults.color = '#333333';
                Chart.defaults.borderColor = '#ebebeb';
                Chart.defaults.plugins.legend.labels.color = '#333333';
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ†ãƒ¼ãƒã‚’åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', initTheme);
        
        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        let allTrades = [];
        let filteredTrades = [];
        let activeCharts = [];
        let currentTradingStyle = 'all';

        // --- DOMè¦ç´ ã®å–å¾— ---
        const fileInput = document.getElementById('fileInput');
        const fileNameEl = document.getElementById('fileName');
        const fileInfoEl = document.getElementById('fileInfo');
        const tradePeriodEl = document.getElementById('tradePeriod');
        const tradeCountEl = document.getElementById('tradeCount');
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('errorMessage');
        const analysisRootEl = document.getElementById('analysisRoot');
        const filterSectionEl = document.getElementById('filterSection');
        const tradingStyleSectionEl = document.getElementById('tradingStyleSection');
        const symbolFilterEl = document.getElementById('symbolFilter');
        const positionFilterEl = document.getElementById('positionFilter');
        const weekdayFilterEl = document.getElementById('weekdayFilter');
        const timeFilterEl = document.getElementById('timeFilter');
        const resultFilterEl = document.getElementById('resultFilter');
        const popupOverlay = document.getElementById('popupOverlay');
        const popupTitle = document.getElementById('popupTitle');
        const popupBody = document.getElementById('popupBody');
        const popupClose = document.getElementById('popupClose');
        const sidePanel = document.getElementById('sidePanel');
        const sidePanelTitle = document.getElementById('sidePanelTitle');
        const sidePanelContent = document.getElementById('sidePanelContent');
        const sidePanelClose = document.getElementById('sidePanelClose');
        
        // ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¦ç´ ã‚’å–å¾—
        const sidePanelOverlay = document.getElementById('sidePanelOverlay');

        // --- ãƒ˜ãƒ«ãƒ—èª¬æ˜æ–‡ ---
        const helpTexts = {
            'ç·å–å¼•æ•°': 'åˆ†æå¯¾è±¡æœŸé–“å†…ã«å®Ÿè¡Œã•ã‚ŒãŸå£²è²·å–å¼•ã®ç·å›æ•°ã§ã™ã€‚',
            'å‹ç‡': 'åˆ©ç›Šã‚’å‡ºã—ãŸãƒˆãƒ¬ãƒ¼ãƒ‰ã®å‰²åˆã§ã™ã€‚50%ä»¥ä¸ŠãŒç›®å®‰ã§ã™ã€‚',
            'ç·æç›Š': 'å…¨å–å¼•ã®æç›Šåˆè¨ˆã§ã™ã€‚ãƒ—ãƒ©ã‚¹ãªã‚‰åˆ©ç›Šã€ãƒã‚¤ãƒŠã‚¹ãªã‚‰æå¤±ã§ã™ã€‚',
            'å‹ã¡ãƒˆãƒ¬ãƒ¼ãƒ‰å¹³å‡ä¿æœ‰æ™‚é–“': 'åˆ©ç›Šã‚’å‡ºã—ãŸãƒã‚¸ã‚·ãƒ§ãƒ³ã®å¹³å‡ä¿æœ‰æœŸé–“ã§ã™ã€‚',
            'è² ã‘ãƒˆãƒ¬ãƒ¼ãƒ‰å¹³å‡ä¿æœ‰æ™‚é–“': 'æå¤±ã‚’å‡ºã—ãŸãƒã‚¸ã‚·ãƒ§ãƒ³ã®å¹³å‡ä¿æœ‰æœŸé–“ã§ã™ã€‚',
            'æœ€é•·ä¿æœ‰æ™‚é–“ï¼ˆå‹ã¡ï¼‰': 'å‹ã¡ãƒˆãƒ¬ãƒ¼ãƒ‰ã®ä¸­ã§æœ€ã‚‚é•·ãä¿æœ‰ã—ãŸæ™‚é–“ã§ã™ã€‚',
            'æœ€çŸ­ä¿æœ‰æ™‚é–“ï¼ˆå‹ã¡ï¼‰': 'å‹ã¡ãƒˆãƒ¬ãƒ¼ãƒ‰ã®ä¸­ã§æœ€ã‚‚çŸ­ãä¿æœ‰ã—ãŸæ™‚é–“ã§ã™ã€‚',
            'æœ€é•·ä¿æœ‰æ™‚é–“ï¼ˆè² ã‘ï¼‰': 'è² ã‘ãƒˆãƒ¬ãƒ¼ãƒ‰ã®ä¸­ã§æœ€ã‚‚é•·ãä¿æœ‰ã—ãŸæ™‚é–“ã§ã™ã€‚',
            'æœ€çŸ­ä¿æœ‰æ™‚é–“ï¼ˆè² ã‘ï¼‰': 'è² ã‘ãƒˆãƒ¬ãƒ¼ãƒ‰ã®ä¸­ã§æœ€ã‚‚çŸ­ãä¿æœ‰ã—ãŸæ™‚é–“ã§ã™ã€‚',
            'ä¿æœ‰æ™‚é–“åˆ†å¸ƒ': 'ä¿æœ‰æ™‚é–“åˆ¥ã®å–å¼•å›æ•°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚å‹ã¡è² ã‘åˆ¥ã«è‰²åˆ†ã‘ã•ã‚Œã¦ã„ã¾ã™ã€‚'
        };

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        fileInput.addEventListener('change', handleFileUpload);
        symbolFilterEl.addEventListener('change', applyFilters);
        positionFilterEl.addEventListener('change', applyFilters);
        weekdayFilterEl.addEventListener('change', applyFilters);
        timeFilterEl.addEventListener('change', applyFilters);
        resultFilterEl.addEventListener('change', applyFilters);
        popupClose.addEventListener('click', closePopup);
        popupOverlay.addEventListener('click', (e) => {
            if (e.target === popupOverlay) closePopup();
        });
        sidePanelClose.addEventListener('click', closeSidePanel);
        
        // ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        sidePanelOverlay.addEventListener('click', function() {
            console.log('Overlay clicked');
            closeSidePanel();
        });
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã®å®šç¾©
        window.loadDemoData = function() {
            console.log('Loading demo data...');
            setLoading(true);
            
            // ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
            const demoTrades = generateDemoTrades();
            allTrades = demoTrades;
            filteredTrades = [...allTrades];
            
            fileNameEl.textContent = 'ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ä¸­';
            displayFileInfo(allTrades);
            populateFilters();
            updateTradingStyleCounts();
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºå®Ÿã«è¡¨ç¤º
            const filterSection = document.getElementById('filterSection');
            if (filterSection) {
                filterSection.style.display = 'block';
                console.log('Filter section displayed');
            }
            
            // ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚‚è¡¨ç¤º
            tradingStyleSectionEl.style.display = 'block';
            
            renderAnalysis(filteredTrades);
            setLoading(false);
        };
        
        window.showHelp = function(title) {
            popupTitle.textContent = title;
            popupBody.textContent = helpTexts[title] || 'èª¬æ˜ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
            popupOverlay.style.display = 'flex';
        };
        
        // ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã‚’åˆ¤å®šã™ã‚‹é–¢æ•°ï¼ˆæ”¹è‰¯ç‰ˆã®æ™‚é–“åŒºåˆ†ï¼‰
        function getTradingStyle(duration) {
            const minutes = duration / (1000 * 60);
            const hours = duration / (1000 * 60 * 60);
            
            if (minutes <= 30) return 'scalping';      // 30åˆ†ä»¥å†…
            if (hours <= 4) return 'day';              // 30åˆ†ã€œ4æ™‚é–“
            if (hours <= 24) return 'swing';           // 4æ™‚é–“ã€œ1æ—¥
            return 'position';                          // 1æ—¥ä»¥ä¸Š
        }
        
        // ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«åˆ¥ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
        function updateTradingStyleCounts() {
            const styleCounts = {
                all: allTrades.length,
                scalping: 0,
                day: 0,
                swing: 0,
                position: 0
            };
            
            const styleStats = {
                scalping: { wins: 0, losses: 0, profit: 0 },
                day: { wins: 0, losses: 0, profit: 0 },
                swing: { wins: 0, losses: 0, profit: 0 },
                position: { wins: 0, losses: 0, profit: 0 }
            };
            
            allTrades.forEach(trade => {
                const style = getTradingStyle(trade.duration);
                styleCounts[style]++;
                
                if (trade.isWin) {
                    styleStats[style].wins++;
                } else {
                    styleStats[style].losses++;
                }
                styleStats[style].profit += trade.profit;
            });
            
            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
            updatePerformanceCards(styleCounts, styleStats);
            
            // è¤‡åˆãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆ
            createStyleComparisonChart(styleCounts, styleStats);
        }
        
        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
        function updatePerformanceCards(styleCounts, styleStats) {
            const styles = ['scalping', 'day', 'swing', 'position'];
            
            styles.forEach(style => {
                const count = styleCounts[style];
                const stats = styleStats[style];
                
                // å–å¼•æ•°
                const countEl = document.getElementById(`count${style.charAt(0).toUpperCase() + style.slice(1)}`);
                countEl.textContent = `${count}å›`;
                countEl.className = 'metric-value neutral';
                
                // å‹ç‡
                const winRateEl = document.getElementById(`winRate${style.charAt(0).toUpperCase() + style.slice(1)}`);
                if (count > 0) {
                    const winRate = (stats.wins / count * 100).toFixed(1);
                    winRateEl.textContent = `${winRate}%`;
                    winRateEl.className = `metric-value ${winRate >= 55 ? 'positive' : winRate >= 45 ? 'neutral' : 'negative'}`;
                } else {
                    winRateEl.textContent = '-';
                    winRateEl.className = 'metric-value neutral';
                }
                
                // æœŸå¾…å€¤ï¼ˆEVï¼‰
                const evEl = document.getElementById(`ev${style.charAt(0).toUpperCase() + style.slice(1)}`);
                if (count > 0) {
                    const ev = stats.profit / count;
                    evEl.textContent = `Â¥${Math.round(ev).toLocaleString()}`;
                    evEl.className = `metric-value ${ev > 0 ? 'positive' : 'negative'}`;
                } else {
                    evEl.textContent = '-';
                    evEl.className = 'metric-value neutral';
                }
                
                // æ¨å¥¨äº‹é …
                const recEl = document.getElementById(`rec${style.charAt(0).toUpperCase() + style.slice(1)}`);
                if (count > 0) {
                    const winRate = stats.wins / count;
                    const ev = stats.profit / count;
                    
                    if (ev > 1000 && winRate >= 0.6) {
                        recEl.textContent = 'âœ¨ å„ªç§€ï¼ã“ã®ã‚¹ã‚¿ã‚¤ãƒ«ãŒæœ€é©ã§ã™';
                        recEl.className = 'style-perf-recommendation excellent';
                    } else if (ev > 0 && winRate >= 0.5) {
                        recEl.textContent = 'ğŸ“ˆ è‰¯å¥½ã€‚ç¶™ç¶šã—ã¦æ”¹å–„ã—ã¾ã—ã‚‡ã†';
                        recEl.className = 'style-perf-recommendation';
                    } else if (ev < 0 && count < 10) {
                        recEl.textContent = 'âš ï¸ ã‚µãƒ³ãƒ—ãƒ«æ•°ãŒå°‘ãªã„ãŸã‚è©•ä¾¡å›°é›£';
                        recEl.className = 'style-perf-recommendation warning';
                    } else if (ev < 0) {
                        recEl.textContent = 'ğŸ”´ æ”¹å–„ãŒå¿…è¦ã€‚ãƒ«ãƒ¼ãƒ«ã®è¦‹ç›´ã—ã‚’';
                        recEl.className = 'style-perf-recommendation danger';
                    } else {
                        recEl.textContent = 'ğŸ“Š ã•ã‚‰ãªã‚‹æ¤œè¨¼ãŒå¿…è¦ã§ã™';
                        recEl.className = 'style-perf-recommendation';
                    }
                } else {
                    recEl.textContent = 'ãƒ‡ãƒ¼ã‚¿ãªã—';
                    recEl.className = 'style-perf-recommendation';
                }
            });
        }
        
        // è¤‡åˆãƒãƒ£ãƒ¼ãƒˆï¼ˆç©ã¿ä¸Šã’æ£’ã‚°ãƒ©ãƒ•ï¼‹å‹ç‡æŠ˜ã‚Œç·šï¼‰ã‚’ä½œæˆ
        function createStyleComparisonChart(styleCounts, styleStats) {
            const ctx = document.getElementById('styleDistributionChart');
            if (!ctx) return;
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆãŒã‚ã‚Œã°ç ´æ£„
            const existingChart = Chart.getChart(ctx);
            if (existingChart) {
                existingChart.destroy();
            }
            
            const labels = ['ã‚¹ã‚­ãƒ£ãƒ«ãƒ”ãƒ³ã‚°', 'ãƒ‡ã‚¤ãƒˆãƒ¬ãƒ¼ãƒ‰', 'ã‚¹ã‚¤ãƒ³ã‚°', 'ãƒã‚¸ã‚·ãƒ§ãƒ³'];
            const styles = ['scalping', 'day', 'swing', 'position'];
            
            const winData = styles.map(style => styleStats[style].wins);
            const lossData = styles.map(style => styleStats[style].losses);
            const winRates = styles.map(style => {
                const total = styleStats[style].wins + styleStats[style].losses;
                return total > 0 ? (styleStats[style].wins / total * 100) : 0;
            });
            const evData = styles.map(style => {
                const total = styleCounts[style];
                return total > 0 ? Math.round(styleStats[style].profit / total) : 0;
            });
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'å‹ã¡ãƒˆãƒ¬ãƒ¼ãƒ‰',
                            data: winData,
                            backgroundColor: 'rgba(0, 200, 255, 0.8)',
                            borderColor: '#00c8ff',
                            borderWidth: 1,
                            stack: 'Stack 0'
                        },
                        {
                            label: 'è² ã‘ãƒˆãƒ¬ãƒ¼ãƒ‰',
                            data: lossData,
                            backgroundColor: 'rgba(255, 50, 0, 0.8)',
                            borderColor: '#ff3200',
                            borderWidth: 1,
                            stack: 'Stack 0'
                        },
                        {
                            label: 'å‹ç‡ (%)',
                            data: winRates,
                            type: 'line',
                            borderColor: '#00c8ff',
                            backgroundColor: 'rgba(0, 200, 255, 0.1)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointBackgroundColor: '#00c8ff',
                            yAxisID: 'y1',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            color: '#e0e0e0',
                            padding: {
                                bottom: 20
                            }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 11
                                },
                                color: '#e0e0e0'
                            }
                        },
                        tooltip: {
                            backgroundColor: '#181818',
                            borderColor: '#373737',
                            borderWidth: 1,
                            titleColor: '#e0e0e0',
                            bodyColor: '#aaa',
                            callbacks: {
                                afterLabel: function(context) {
                                    if (context.datasetIndex < 2) {
                                        const index = context.dataIndex;
                                        const ev = evData[index];
                                        return `æœŸå¾…å€¤: Â¥${ev.toLocaleString()}`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«',
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#ffffff' 
                                    : '#333333'
                            },
                            grid: {
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#373737' 
                                    : '#ebebeb'
                            },
                            ticks: {
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#ffffff' 
                                    : '#333333'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'å–å¼•å›æ•°',
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#ffffff' 
                                    : '#333333'
                            },
                            beginAtZero: true,
                            grid: {
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#373737' 
                                    : '#ebebeb'
                            },
                            ticks: {
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#ffffff' 
                                    : '#333333'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'å‹ç‡ (%)',
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#ffffff' 
                                    : '#333333'
                            },
                            min: 0,
                            max: 100,
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#ffffff' 
                                    : '#333333'
                            }
                        }
                    }
                }
            });
        }
        
        function generateDemoTrades() {
            const trades = [];
            const symbols = ['USDJPY', 'EURUSD', 'GBPUSD', 'AUDUSD', 'EURJPY'];
            const baseDate = new Date(2024, 0, 1); // 2024å¹´1æœˆ1æ—¥ã‹ã‚‰
            
            for (let i = 0; i < 100; i++) {
                const openTime = new Date(baseDate.getTime() + Math.random() * 90 * 24 * 60 * 60 * 1000); // 90æ—¥é–“ã®ãƒ©ãƒ³ãƒ€ãƒ 
                const duration = Math.random() * 48 * 60 * 60 * 1000; // æœ€å¤§48æ™‚é–“
                const closeTime = new Date(openTime.getTime() + duration);
                const isWin = Math.random() > 0.45; // å‹ç‡55%
                const profit = isWin ? 
                    (Math.random() * 50000 + 5000) : // å‹ã¡: 5,000-55,000å††
                    -(Math.random() * 30000 + 5000);  // è² ã‘: -5,000--35,000å††
                
                trades.push({
                    ticket: `#${100000 + i}`,
                    openTime: openTime,
                    closeTime: closeTime,
                    type: Math.random() > 0.5 ? 'buy' : 'sell',
                    size: 0.1,
                    symbol: symbols[Math.floor(Math.random() * symbols.length)],
                    profit: profit,
                    isWin: isWin,
                    duration: duration
                });
            }
            
            return trades.sort((a, b) => a.openTime.getTime() - b.openTime.getTime());
        }
        
        function populateFilters() {
            // é€šè²¨ãƒšã‚¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const symbols = [...new Set(allTrades.map(t => t.symbol))];
            symbolFilterEl.innerHTML = '<option value="all">ã™ã¹ã¦ã®é€šè²¨ãƒšã‚¢</option>';
            symbols.sort().forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                symbolFilterEl.appendChild(option);
            });
        }
        
        function applyFilters() {
            if (!allTrades || allTrades.length === 0) {
                console.log('No trades to filter');
                return;
            }
            
            filteredTrades = [...allTrades];
            console.log(`Starting with ${filteredTrades.length} trades`);
            
            // é€šè²¨ãƒšã‚¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const symbol = symbolFilterEl.value;
            if (symbol !== 'all') {
                filteredTrades = filteredTrades.filter(t => t.symbol === symbol);
                console.log(`After symbol filter: ${filteredTrades.length} trades`);
            }
            
            // ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const position = positionFilterEl.value;
            if (position !== 'all') {
                filteredTrades = filteredTrades.filter(t => t.type === position);
                console.log(`After position filter: ${filteredTrades.length} trades`);
            }
            
            // æ›œæ—¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const weekday = weekdayFilterEl.value;
            if (weekday !== 'all') {
                filteredTrades = filteredTrades.filter(t => t.openTime.getDay() === parseInt(weekday));
                console.log(`After weekday filter: ${filteredTrades.length} trades`);
            }
            
            // æ™‚é–“å¸¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const timeRange = timeFilterEl.value;
            if (timeRange !== 'all') {
                filteredTrades = filteredTrades.filter(t => {
                    const hour = t.openTime.getHours();
                    switch(timeRange) {
                        case 'morning': return hour >= 6 && hour < 12;
                        case 'afternoon': return hour >= 12 && hour < 18;
                        case 'evening': return hour >= 18 && hour < 24;
                        case 'night': return hour >= 0 && hour < 6;
                        default: return true;
                    }
                });
                console.log(`After time filter: ${filteredTrades.length} trades`);
            }
            
            // å‹æ•—ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const result = resultFilterEl.value;
            if (result === 'win') {
                filteredTrades = filteredTrades.filter(t => t.isWin);
                console.log(`After win filter: ${filteredTrades.length} trades`);
            } else if (result === 'loss') {
                filteredTrades = filteredTrades.filter(t => !t.isWin);
                console.log(`After loss filter: ${filteredTrades.length} trades`);
            }
            
            renderAnalysis(filteredTrades);
        }
        
        // --- ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ ---
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            resetAnalysisView();
            fileNameEl.textContent = `é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: ${file.name}`;
            setLoading(true);

            const reader = new FileReader();
            reader.onload = (e) => parseMT4History(e.target.result);
            reader.readAsText(file, 'UTF-8');
        }

        function parseMT4History(htmlContent) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                const tables = doc.querySelectorAll('table');
                let parsedTrades = [];
                
                tables.forEach(table => {
                    parsedTrades = parsedTrades.concat(parseTableData(table));
                });
                
                if (parsedTrades && parsedTrades.length > 0) {
                    allTrades = parsedTrades.map(trade => ({
                        ...trade,
                        duration: trade.closeTime.getTime() - trade.openTime.getTime()
                    })).sort((a, b) => a.openTime.getTime() - b.openTime.getTime());
                    
                    filteredTrades = [...allTrades];
                    displayFileInfo(allTrades);
                    populateFilters();
                    updateTradingStyleCounts();
                    filterSectionEl.style.display = 'block';
                    tradingStyleSectionEl.style.display = 'block';
                    renderAnalysis(filteredTrades);
                } else {
                    showError('ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å–å¼•ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
                }
            } catch (error) {
                console.error('Parse error:', error);
                showError('ãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                setLoading(false);
            }
        }

        function parseTableData(table) {
            const rows = table.querySelectorAll('tr');
            const parsedTrades = [];
            let headerMapping = {};
            let dataStartIndex = -1;
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’æ¢ã™
            for (let i = 0; i < Math.min(10, rows.length); i++) {
                const cells = rows[i].querySelectorAll('td, th');
                if (cells.length < 10) continue;
                
                const cellTexts = Array.from(cells).map(cell => cell.textContent.trim().toLowerCase());
                
                if (cellTexts.some(text => text.includes('ticket')) && 
                    cellTexts.some(text => text.includes('time')) && 
                    cellTexts.some(text => text.includes('type'))) {
                    
                    cellTexts.forEach((text, idx) => {
                        if (text.includes('ticket')) headerMapping.ticket = idx;
                        if (text.includes('open time')) headerMapping.openTime = idx;
                        if (text.includes('type')) headerMapping.type = idx;
                        if (text.includes('size') || text.includes('volume')) headerMapping.size = idx;
                        if (text.includes('item') || text.includes('symbol')) headerMapping.symbol = idx;
                        if (text.includes('price') && !headerMapping.openPrice) headerMapping.openPrice = idx;
                        if (text.includes('close time')) headerMapping.closeTime = idx;
                        if (text.includes('profit')) headerMapping.profit = idx;
                    });
                    dataStartIndex = i + 1;
                    break;
                }
            }
            
            if (dataStartIndex === -1) return [];
            
            // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’è§£æ
            for (let i = dataStartIndex; i < rows.length; i++) {
                const cells = rows[i].querySelectorAll('td');
                if (cells.length < 10) continue;
                
                const cellTexts = Array.from(cells).map(cell => cell.textContent.trim());
                const type = (cellTexts[headerMapping.type] || '').toLowerCase();
                
                if (type !== 'buy' && type !== 'sell') continue;
                if (!/^\d+$/.test(cellTexts[headerMapping.ticket])) continue;
                
                let profit = 0;
                const profitIndex = headerMapping.profit !== undefined ? headerMapping.profit : cells.length - 1;
                if (cellTexts[profitIndex]) {
                    profit = parseFloat(cellTexts[profitIndex].replace(/[^0-9\.-]/g, ''));
                }
                
                if (isNaN(profit)) continue;
                
                const openTime = parseDateTime(cellTexts[headerMapping.openTime]);
                const closeTime = parseDateTime(cellTexts[headerMapping.closeTime]);
                
                if (!openTime || !closeTime) continue;
                
                parsedTrades.push({
                    ticket: cellTexts[headerMapping.ticket],
                    openTime,
                    closeTime,
                    type,
                    size: parseFloat(cellTexts[headerMapping.size] || '0'),
                    symbol: cellTexts[headerMapping.symbol],
                    profit,
                    isWin: profit > 0
                });
            }
            
            return parsedTrades;
        }
        
        function parseDateTime(dateStr) {
            if (!dateStr) return null;
            const match = dateStr.match(/(\d{4})[./](\d{2})[./](\d{2})\s+(\d{2}):(\d{2})/);
            if (match) {
                const [, year, month, day, hour, minute] = match.map(Number);
                const d = new Date(year, month - 1, day, hour, minute);
                if (!isNaN(d.getTime())) return d;
            }
            return null;
        }

        function displayFileInfo(trades) {
            if (trades.length === 0) return;
            
            const startDate = new Date(Math.min(...trades.map(t => t.openTime.getTime())));
            const endDate = new Date(Math.max(...trades.map(t => t.closeTime.getTime())));
            
            const formatDate = (date) => {
                return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
            };
            
            tradePeriodEl.textContent = `æœŸé–“: ${formatDate(startDate)} ã€œ ${formatDate(endDate)}`;
            tradeCountEl.textContent = `ç·å–å¼•æ•°: ${trades.length}å›`;
            fileInfoEl.style.display = 'block';
        }

        function renderAnalysis(trades) {
            resetAnalysisView(true); // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¯ç¶­æŒ
            
            if (!trades || trades.length === 0) {
                showError("é¸æŠã•ã‚ŒãŸæ¡ä»¶ã«ä¸€è‡´ã™ã‚‹å–å¼•ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }

            console.log(`Rendering analysis for ${trades.length} trades`);
            const stats = calculateStatistics(trades);
            
            analysisRootEl.innerHTML = `
                <!-- ä¿æœ‰æ™‚é–“ãƒ¡ãƒˆãƒªã‚¯ã‚¹ -->
                <div class="analysis-section">
                    <div class="metric-card">
                        <div class="metric-card-header">
                            <span class="metric-card-title">å‹ã¡ãƒˆãƒ¬ãƒ¼ãƒ‰å¹³å‡ä¿æœ‰æ™‚é–“</span>
                            <span class="help-icon" onclick="showHelp('å‹ã¡ãƒˆãƒ¬ãƒ¼ãƒ‰å¹³å‡ä¿æœ‰æ™‚é–“')">?</span>
                        </div>
                        <div class="metric-card-value neutral">${formatDuration(stats.avgWinDuration)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-card-header">
                            <span class="metric-card-title">è² ã‘ãƒˆãƒ¬ãƒ¼ãƒ‰å¹³å‡ä¿æœ‰æ™‚é–“</span>
                            <span class="help-icon" onclick="showHelp('è² ã‘ãƒˆãƒ¬ãƒ¼ãƒ‰å¹³å‡ä¿æœ‰æ™‚é–“')">?</span>
                        </div>
                        <div class="metric-card-value neutral">${formatDuration(stats.avgLossDuration)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-card-header">
                            <span class="metric-card-title">æœ€é•·ä¿æœ‰æ™‚é–“ï¼ˆå‹ã¡ï¼‰</span>
                            <span class="help-icon" onclick="showHelp('æœ€é•·ä¿æœ‰æ™‚é–“ï¼ˆå‹ã¡ï¼‰')">?</span>
                        </div>
                        <div class="metric-card-value neutral">${formatDuration(stats.maxWinDuration)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-card-header">
                            <span class="metric-card-title">æœ€çŸ­ä¿æœ‰æ™‚é–“ï¼ˆå‹ã¡ï¼‰</span>
                            <span class="help-icon" onclick="showHelp('æœ€çŸ­ä¿æœ‰æ™‚é–“ï¼ˆå‹ã¡ï¼‰')">?</span>
                        </div>
                        <div class="metric-card-value neutral">${formatDuration(stats.minWinDuration)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-card-header">
                            <span class="metric-card-title">æœ€é•·ä¿æœ‰æ™‚é–“ï¼ˆè² ã‘ï¼‰</span>
                            <span class="help-icon" onclick="showHelp('æœ€é•·ä¿æœ‰æ™‚é–“ï¼ˆè² ã‘ï¼‰')">?</span>
                        </div>
                        <div class="metric-card-value neutral">${formatDuration(stats.maxLossDuration)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-card-header">
                            <span class="metric-card-title">æœ€çŸ­ä¿æœ‰æ™‚é–“ï¼ˆè² ã‘ï¼‰</span>
                            <span class="help-icon" onclick="showHelp('æœ€çŸ­ä¿æœ‰æ™‚é–“ï¼ˆè² ã‘ï¼‰')">?</span>
                        </div>
                        <div class="metric-card-value neutral">${formatDuration(stats.minLossDuration)}</div>
                    </div>
                </div>
                
                <!-- ä¿æœ‰æ™‚é–“åˆ†å¸ƒãƒãƒ£ãƒ¼ãƒˆ -->
                <div class="chart-container">
                    <h3>ä¿æœ‰æ™‚é–“åˆ†å¸ƒ<span class="help-icon" onclick="showHelp('ä¿æœ‰æ™‚é–“åˆ†å¸ƒ')">?</span></h3>
                    <canvas id="durationChart"></canvas>
                </div>
            `;
            
            // ãƒãƒ£ãƒ¼ãƒˆä½œæˆ
            createDurationChart(trades);
        }

        function calculateStatistics(trades) {
            const winTrades = trades.filter(t => t.isWin);
            const lossTrades = trades.filter(t => !t.isWin);
            const totalProfit = trades.reduce((sum, t) => sum + t.profit, 0);
            
            // ä¿æœ‰æ™‚é–“ã®çµ±è¨ˆè¨ˆç®—
            const winDurations = winTrades.map(t => t.duration);
            const lossDurations = lossTrades.map(t => t.duration);
            
            const avgWinDuration = winDurations.length > 0 ? 
                winDurations.reduce((sum, d) => sum + d, 0) / winDurations.length : 0;
            const avgLossDuration = lossDurations.length > 0 ? 
                lossDurations.reduce((sum, d) => sum + d, 0) / lossDurations.length : 0;
            
            const maxWinDuration = winDurations.length > 0 ? Math.max(...winDurations) : 0;
            const minWinDuration = winDurations.length > 0 ? Math.min(...winDurations) : 0;
            const maxLossDuration = lossDurations.length > 0 ? Math.max(...lossDurations) : 0;
            const minLossDuration = lossDurations.length > 0 ? Math.min(...lossDurations) : 0;
            
            return {
                totalTrades: trades.length,
                winRatePercent: trades.length > 0 ? 
                    (winTrades.length / trades.length * 100).toFixed(1) : "0.0",
                totalProfit,
                avgWinDuration,
                avgLossDuration,
                maxWinDuration,
                minWinDuration,
                maxLossDuration,
                minLossDuration,
                winTrades: winTrades.length,
                lossTrades: lossTrades.length
            };
        }

        function formatDuration(milliseconds) {
            if (!milliseconds || milliseconds === 0) return '0åˆ†';
            
            const totalMinutes = Math.floor(milliseconds / (1000 * 60));
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const days = Math.floor(hours / 24);
            const remainingHours = hours % 24;
            
            if (days > 0) {
                return `${days}æ—¥${remainingHours}æ™‚é–“${minutes}åˆ†`;
            } else if (hours > 0) {
                return `${hours}æ™‚é–“${minutes}åˆ†`;
            } else {
                return `${minutes}åˆ†`;
            }
        }

        function createDurationChart(trades) {
            const ctx = document.getElementById('durationChart');
            if (!ctx) return;
            
            // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆãŒã‚ã‚Œã°ç ´æ£„
            activeCharts.forEach(chart => chart.destroy());
            activeCharts = [];
            
            // ä¿æœ‰æ™‚é–“ã‚’ç¯„å›²åˆ¥ã«åˆ†é¡ï¼ˆåˆ†å˜ä½ï¼‰
            const ranges = [
                { min: 0, max: 30, label: 'ã€œ30åˆ†' },
                { min: 30, max: 60, label: '30åˆ†ã€œ1æ™‚é–“' },
                { min: 60, max: 180, label: '1ã€œ3æ™‚é–“' },
                { min: 180, max: 360, label: '3ã€œ6æ™‚é–“' },
                { min: 360, max: 720, label: '6ã€œ12æ™‚é–“' },
                { min: 720, max: 1440, label: '12ã€œ24æ™‚é–“' },
                { min: 1440, max: 2880, label: '1ã€œ2æ—¥' },
                { min: 2880, max: Infinity, label: '2æ—¥ä»¥ä¸Š' }
            ];

            const winDistribution = ranges.map(range => {
                const count = trades.filter(t => {
                    const minutes = t.duration / 60000;
                    return t.isWin && minutes > range.min && minutes <= range.max;
                }).length;
                return count;
            });
            
            const lossDistribution = ranges.map(range => {
                const count = trades.filter(t => {
                    const minutes = t.duration / 60000;
                    return !t.isWin && minutes > range.min && minutes <= range.max;
                }).length;
                return count;
            });

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ranges.map(r => r.label),
                    datasets: [
                        {
                            label: 'å‹ã¡ãƒˆãƒ¬ãƒ¼ãƒ‰',
                            data: winDistribution,
                            backgroundColor: document.documentElement.getAttribute('data-theme') === 'dark' 
                                ? 'rgba(0, 200, 255, 0.8)' 
                                : 'rgba(0, 126, 255, 0.8)',
                            borderColor: document.documentElement.getAttribute('data-theme') === 'dark' 
                                ? '#00c8ff' 
                                : '#007eff',
                            borderWidth: 1
                        },
                        {
                            label: 'è² ã‘ãƒˆãƒ¬ãƒ¼ãƒ‰',
                            data: lossDistribution,
                            backgroundColor: document.documentElement.getAttribute('data-theme') === 'dark' 
                                ? 'rgba(255, 50, 0, 0.8)' 
                                : 'rgba(255, 40, 0, 0.8)',
                            borderColor: document.documentElement.getAttribute('data-theme') === 'dark' 
                                ? '#ff3200' 
                                : '#ff2800',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            showDurationDrillDown(ranges[index], trades);
                        }
                    },
                    plugins: {
                        tooltip: {
                            backgroundColor: document.documentElement.getAttribute('data-theme') === 'dark' 
                                ? '#181818' 
                                : '#fafafa',
                            borderColor: document.documentElement.getAttribute('data-theme') === 'dark' 
                                ? '#373737' 
                                : '#ebebeb',
                            borderWidth: 1,
                            titleColor: document.documentElement.getAttribute('data-theme') === 'dark' 
                                ? '#ffffff' 
                                : '#333333',
                            bodyColor: document.documentElement.getAttribute('data-theme') === 'dark' 
                                ? '#ffffff' 
                                : '#333333',
                            callbacks: {
                                afterLabel: function(context) {
                                    return 'ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ã‚’è¡¨ç¤º';
                                }
                            }
                        },
                        legend: {
                            labels: {
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#ffffff' 
                                    : '#333333'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { 
                                display: true, 
                                text: 'ä¿æœ‰æ™‚é–“',
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#ffffff' 
                                    : '#333333'
                            },
                            grid: {
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#373737' 
                                    : '#ebebeb'
                            },
                            ticks: {
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#ffffff' 
                                    : '#333333'
                            }
                        },
                        y: {
                            title: { 
                                display: true, 
                                text: 'å–å¼•å›æ•°',
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#ffffff' 
                                    : '#333333'
                            },
                            beginAtZero: true,
                            grid: {
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#373737' 
                                    : '#ebebeb'
                            },
                            ticks: {
                                color: document.documentElement.getAttribute('data-theme') === 'dark' 
                                    ? '#ffffff' 
                                    : '#333333'
                            }
                        }
                    }
                }
            });
            
            activeCharts.push(chart);
        }

        function showDurationDrillDown(range, trades) {
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è©²å½“ã™ã‚‹ä¿æœ‰æ™‚é–“ç¯„å›²ã®å–å¼•ã‚’æŠ½å‡º
            const filteredRangeTrades = trades.filter(t => {
                const minutes = t.duration / 60000;
                return minutes > range.min && minutes <= range.max;
            });
            
            if (filteredRangeTrades.length === 0) {
                alert('ã“ã®æ™‚é–“ç¯„å›²ã«ã¯ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            const winTrades = filteredRangeTrades.filter(t => t.isWin);
            const lossTrades = filteredRangeTrades.filter(t => !t.isWin);
            const totalProfit = filteredRangeTrades.reduce((sum, t) => sum + t.profit, 0);
            const avgProfit = totalProfit / filteredRangeTrades.length;
            const winRate = (winTrades.length / filteredRangeTrades.length * 100).toFixed(1);
            
            sidePanelTitle.textContent = `ä¿æœ‰æ™‚é–“ ${range.label} ã®è©³ç´°åˆ†æ`;
            
            sidePanelContent.innerHTML = `
                <div class="drill-section">
                    <h3>åŸºæœ¬çµ±è¨ˆ</h3>
                    <div class="drill-stats">
                        <div class="drill-stat-item">
                            <div class="drill-stat-value">${filteredRangeTrades.length}å›</div>
                            <div class="drill-stat-label">ç·å–å¼•æ•°</div>
                        </div>
                        <div class="drill-stat-item">
                            <div class="drill-stat-value ${winRate >= 50 ? 'positive' : 'negative'}">${winRate}%</div>
                            <div class="drill-stat-label">å‹ç‡</div>
                        </div>
                        <div class="drill-stat-item">
                            <div class="drill-stat-value ${totalProfit >= 0 ? 'positive' : 'negative'}">Â¥${Math.round(totalProfit).toLocaleString()}</div>
                            <div class="drill-stat-label">ç·æç›Š</div>
                        </div>
                        <div class="drill-stat-item">
                            <div class="drill-stat-value ${avgProfit >= 0 ? 'positive' : 'negative'}">Â¥${Math.round(avgProfit).toLocaleString()}</div>
                            <div class="drill-stat-label">å¹³å‡æç›Š</div>
                        </div>
                    </div>
                </div>
                
                <div class="drill-section">
                    <h3>å‹ã¡ãƒˆãƒ¬ãƒ¼ãƒ‰çµ±è¨ˆ</h3>
                    <div class="drill-stats">
                        <div class="drill-stat-item">
                            <div class="drill-stat-value neutral">${winTrades.length}å›</div>
                            <div class="drill-stat-label">å–å¼•å›æ•°</div>
                        </div>
                        <div class="drill-stat-item">
                            <div class="drill-stat-value positive">Â¥${winTrades.length > 0 ? Math.round(winTrades.reduce((sum, t) => sum + t.profit, 0) / winTrades.length).toLocaleString() : 0}</div>
                            <div class="drill-stat-label">å¹³å‡åˆ©ç›Š</div>
                        </div>
                    </div>
                </div>
                
                <div class="drill-section">
                    <h3>è² ã‘ãƒˆãƒ¬ãƒ¼ãƒ‰çµ±è¨ˆ</h3>
                    <div class="drill-stats">
                        <div class="drill-stat-item">
                            <div class="drill-stat-value neutral">${lossTrades.length}å›</div>
                            <div class="drill-stat-label">å–å¼•å›æ•°</div>
                        </div>
                        <div class="drill-stat-item">
                            <div class="drill-stat-value negative">Â¥${lossTrades.length > 0 ? Math.abs(Math.round(lossTrades.reduce((sum, t) => sum + t.profit, 0) / lossTrades.length)).toLocaleString() : 0}</div>
                            <div class="drill-stat-label">å¹³å‡æå¤±</div>
                        </div>
                    </div>
                </div>
                
                <div class="drill-section">
                    <h3>åˆ†æã¨æ¨å¥¨äº‹é …</h3>
                    <div class="drill-insights">
                        <h4>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©•ä¾¡</h4>
                        <ul>
                            ${generateInsights(range, winRate, avgProfit, filteredRangeTrades)}
                        </ul>
                    </div>
                </div>
            `;
            
            sidePanel.classList.add('open');
            sidePanelOverlay.classList.add('open');
        }

        function generateInsights(range, winRate, avgProfit, trades) {
            let insights = [];
            
            // ä¿æœ‰æ™‚é–“ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®åˆ¤å®š
            if (range.max <= 60) {
                insights.push('<li>ã“ã®æ™‚é–“å¸¯ã¯ã‚¹ã‚­ãƒ£ãƒ«ãƒ”ãƒ³ã‚°å–å¼•ã«è©²å½“ã—ã¾ã™ã€‚</li>');
                if (parseFloat(winRate) >= 60) {
                    insights.push('<li>é«˜ã„å‹ç‡ã‚’ç¶­æŒã§ãã¦ã„ã¾ã™ã€‚çŸ­æœŸå£²è²·æˆ¦ç•¥ãŒæ©Ÿèƒ½ã—ã¦ã„ã¾ã™ã€‚</li>');
                } else {
                    insights.push('<li>å‹ç‡å‘ä¸Šã®ãŸã‚ã€ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã®ç²¾åº¦ã‚’é«˜ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</li>');
                }
            } else if (range.max <= 720) {
                insights.push('<li>ã“ã®æ™‚é–“å¸¯ã¯ãƒ‡ã‚¤ãƒˆãƒ¬ãƒ¼ãƒ‰ã«è©²å½“ã—ã¾ã™ã€‚</li>');
                if (avgProfit > 0) {
                    insights.push('<li>æ—¥ä¸­ã®å€¤å‹•ãã‚’åŠ¹æœçš„ã«æ‰ãˆã¦ã„ã¾ã™ã€‚</li>');
                } else {
                    insights.push('<li>æåˆ‡ã‚Šã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®è¦‹ç›´ã—ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚</li>');
                }
            } else {
                insights.push('<li>ã“ã®æ™‚é–“å¸¯ã¯ã‚¹ã‚¤ãƒ³ã‚°/ãƒã‚¸ã‚·ãƒ§ãƒ³ãƒˆãƒ¬ãƒ¼ãƒ‰ã«è©²å½“ã—ã¾ã™ã€‚</li>');
                if (avgProfit > 0) {
                    insights.push('<li>é•·æœŸä¿æœ‰æˆ¦ç•¥ãŒåˆ©ç›Šã‚’ç”Ÿã‚“ã§ã„ã¾ã™ã€‚</li>');
                } else {
                    insights.push('<li>é•·æœŸä¿æœ‰ã®ãƒªã‚¹ã‚¯ç®¡ç†ã‚’å¼·åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</li>');
                }
            }
            
            // ãƒªã‚¹ã‚¯ãƒªãƒ¯ãƒ¼ãƒ‰æ¯”ã®è©•ä¾¡
            const winTrades = trades.filter(t => t.isWin);
            const lossTrades = trades.filter(t => !t.isWin);
            if (winTrades.length > 0 && lossTrades.length > 0) {
                const avgWin = winTrades.reduce((sum, t) => sum + t.profit, 0) / winTrades.length;
                const avgLoss = Math.abs(lossTrades.reduce((sum, t) => sum + t.profit, 0) / lossTrades.length);
                const riskReward = avgWin / avgLoss;
                
                if (riskReward > 1.5) {
                    insights.push('<li>å„ªã‚ŒãŸãƒªã‚¹ã‚¯ãƒªãƒ¯ãƒ¼ãƒ‰æ¯”ã‚’é”æˆã—ã¦ã„ã¾ã™ã€‚</li>');
                } else if (riskReward > 1) {
                    insights.push('<li>ãƒªã‚¹ã‚¯ãƒªãƒ¯ãƒ¼ãƒ‰æ¯”ã¯è‰¯å¥½ã§ã™ã€‚</li>');
                } else {
                    insights.push('<li>ãƒªã‚¹ã‚¯ãƒªãƒ¯ãƒ¼ãƒ‰æ¯”ã®æ”¹å–„ãŒå¿…è¦ã§ã™ã€‚</li>');
                }
            }
            
            return insights.join('');
        }

        function closeSidePanel() {
            sidePanel.classList.remove('open');
            sidePanelOverlay.classList.remove('open');
        }

        function resetAnalysisView(keepFilters = false) {
            analysisRootEl.innerHTML = '';
            errorEl.style.display = 'none';
            
            if (!keepFilters) {
                fileInfoEl.style.display = 'none';
                filterSectionEl.style.display = 'none';
                tradingStyleSectionEl.style.display = 'none';
                currentTradingStyle = 'all';
            }
            
            activeCharts.forEach(chart => chart.destroy());
            activeCharts = [];
        }

        function setLoading(isLoading) {
            loadingEl.style.display = isLoading ? 'block' : 'none';
        }

        function showError(message) {
            errorEl.style.display = 'block';
            errorEl.textContent = message;
        }

        function closePopup() {
            popupOverlay.style.display = 'none';
        }
    </script>
</body>
</html>
