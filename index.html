<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FX取引履歴分析ツール - 保有時間分析版</title>
    <style>
        /* CSS変数で色を管理 */
        :root {
            /* ライトモード */
            --bg-primary: #ffffff;
            --bg-secondary: #fafafa;
            --bg-tertiary: #f5f5f5;
            --border-color: #ebebeb;
            --text-primary: #333;
            --text-secondary: #666;
            --text-muted: #999;
            --positive-color: #007eff;
            --negative-color: #ff2800;
            --neutral-color: #6b7280;
            
            /* カード用 */
            --card-bg: #ffffff;
            --card-border: #ebebeb;
            --card-shadow: 0 2px 8px rgba(0,0,0,0.06);
            --hover-shadow: 0 8px 24px rgba(0,0,0,0.1);
            
            /* ボタン用 */
            --button-bg: #007eff;
            --button-hover-shadow: 0 4px 12px rgba(0, 126, 255, 0.3);
            
            /* Chart.js用のグリッド線の色 */
            --chart-grid-color: rgba(0, 0, 0, 0.1);
            --chart-text-color: #666;
        }

        /* ダークモード */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #000000;
                --bg-secondary: #181818;
                --bg-tertiary: #232323;
                --border-color: #373737;
                --text-primary: #e0e0e0;
                --text-secondary: #aaa;
                --text-muted: #777;
                --positive-color: #00c8ff;
                --negative-color: #ff3200;
                
                --card-bg: #181818;
                --card-border: #373737;
                --card-shadow: 0 2px 8px rgba(0,0,0,0.4);
                --hover-shadow: 0 8px 24px rgba(0, 200, 255, 0.15);
                
                --button-bg: #00c8ff;
                --button-hover-shadow: 0 4px 12px rgba(0, 200, 255, 0.3);
                
                /* ダークモード用のChart.jsグリッド線 */
                --chart-grid-color: rgba(255, 255, 255, 0.2);
                --chart-text-color: #aaa;
            }
        }

        /* ダークモード手動切り替え用 */
        body.dark-mode {
            --bg-primary: #000000;
            --bg-secondary: #181818;
            --bg-tertiary: #232323;
            --border-color: #373737;
            --text-primary: #e0e0e0;
            --text-secondary: #aaa;
            --text-muted: #777;
            --positive-color: #00c8ff;
            --negative-color: #ff3200;
            
            --card-bg: #181818;
            --card-border: #373737;
            --card-shadow: 0 2px 8px rgba(0,0,0,0.4);
            --hover-shadow: 0 8px 24px rgba(0, 200, 255, 0.15);
            
            --button-bg: #00c8ff;
            --button-hover-shadow: 0 4px 12px rgba(0, 200, 255, 0.3);
            
            /* ダークモード用のChart.jsグリッド線 */
            --chart-grid-color: rgba(255, 255, 255, 0.2);
            --chart-text-color: #aaa;
        }

        /* 基本スタイル */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
            background: var(--bg-primary);
            min-height: 100vh; 
            color: var(--text-primary);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 40px 20px; 
        }

        /* ヘッダー */
        header { 
            text-align: center; 
            margin-bottom: 40px;
            padding: 30px 20px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
            position: relative;
        }

        h1 { 
            font-size: 2em; 
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
            letter-spacing: 0.02em;
        }

        header p {
            color: var(--text-secondary);
            font-size: 0.95em;
        }

        h2 {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        h3 {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        /* ダークモード切り替えボタン */
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .theme-toggle:hover {
            background: var(--border-color);
        }

        .theme-toggle svg {
            width: 18px;
            height: 18px;
            fill: currentColor;
        }

        .theme-toggle-text {
            display: none;
        }

        @media (min-width: 768px) {
            .theme-toggle-text {
                display: inline;
            }
        }

        /* アップロードセクション */
        .upload-section { 
            background: var(--bg-secondary);
            border-radius: 12px; 
            padding: 24px; 
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
        }

        .upload-section h2 {
            font-size: 1.1em;
            margin-bottom: 16px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .upload-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .file-input-wrapper { 
            position: relative; 
            overflow: hidden; 
            display: inline-block; 
            cursor: pointer; 
            background: var(--button-bg);
            color: white; 
            padding: 10px 24px; 
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 500;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: none;
        }

        .file-input-wrapper:hover {
            transform: translateY(-1px);
            box-shadow: var(--button-hover-shadow);
        }

        #fileInput { 
            display: none;
        }

        .demo-button { 
            background: var(--button-bg);
            color: white;
            padding: 10px 24px; 
            border-radius: 8px; 
            border: none; 
            cursor: pointer; 
            font-size: 0.9em; 
            font-weight: 500;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .demo-button:hover { 
            transform: translateY(-1px);
            box-shadow: var(--button-hover-shadow);
        }

        #fileName {
            margin-top: 12px;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        .file-info { 
            margin-top: 16px; 
            padding: 12px 16px; 
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-size: 0.9em;
            border: 1px solid var(--border-color);
        }

        .file-info h4 { 
            color: var(--text-primary);
            margin-bottom: 4px; 
            font-size: 0.9em;
            font-weight: 600;
        }

        .file-info div { 
            color: var(--text-secondary);
            font-size: 0.85em; 
        }

        /* デモコントロール */
        .demo-controls {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
        }

        .demo-controls h3 {
            font-size: 1em;
            color: var(--text-primary);
            margin-bottom: 12px;
            font-weight: 600;
        }

        .demo-controls button {
            background: var(--button-bg);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 4px;
            font-size: 0.9em;
            font-weight: 500;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .demo-controls button:hover {
            transform: translateY(-1px);
            box-shadow: var(--button-hover-shadow);
        }

        /* フィルターセクション */
        .filter-section { 
            background: var(--bg-secondary);
            border-radius: 12px; 
            padding: 20px; 
            margin-bottom: 24px; 
            display: none; 
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
        }

        .filter-header { 
            color: var(--text-primary);
            font-size: 1.1em; 
            font-weight: 600; 
            margin-bottom: 20px; 
            padding-bottom: 10px; 
            border-bottom: 2px solid var(--border-color);
        }

        .filter-controls { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 20px; 
            align-items: center; 
        }

        .filter-group { 
            display: flex; 
            flex-direction: column; 
        }

        .filter-group label { 
            font-size: 0.9em; 
            color: var(--text-secondary);
            margin-bottom: 5px; 
            font-weight: 500;
        }

        .filter-group select { 
            padding: 8px 12px; 
            border: 1px solid var(--border-color);
            border-radius: 8px; 
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            min-width: 180px; 
            font-size: 0.9em; 
            transition: border-color 0.2s ease;
        }

        .filter-group select:focus {
            border-color: var(--positive-color);
            outline: none;
        }

        /* トレードスタイルセクション */
        .trading-style-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
        }

        .trading-style-header {
            color: var(--text-primary);
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-icon {
            font-size: 1.3em;
        }

        .trading-style-viz {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .style-viz-container {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .style-performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .style-perf-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }

        .style-perf-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--hover-shadow);
        }

        .style-perf-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .style-perf-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1em;
        }

        .style-perf-time {
            font-size: 0.85em;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .style-perf-metrics {
            display: grid;
            gap: 8px;
            margin-bottom: 12px;
        }

        .style-perf-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }

        .style-perf-metric .metric-label {
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .style-perf-metric .metric-value {
            font-weight: 600;
            font-size: 1em;
        }

        .metric-value.positive {
            color: var(--positive-color);
        }

        .metric-value.negative {
            color: var(--negative-color);
        }

        .metric-value.neutral {
            color: var(--text-primary);
        }

        .style-perf-recommendation {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            font-size: 0.85em;
            line-height: 1.4;
            color: var(--text-secondary);
        }

        .style-perf-recommendation.excellent {
            color: var(--positive-color);
            font-weight: 500;
        }

        .style-perf-recommendation.warning {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .style-perf-recommendation.danger {
            color: var(--negative-color);
            font-weight: 500;
        }

        /* 分析セクション */
        .analysis-section { 
            display: grid; 
            gap: 16px; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            margin-bottom: 24px; 
        }

        .metric-card { 
            background: var(--card-bg);
            border-radius: 12px; 
            padding: 20px; 
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--hover-shadow);
        }

        .metric-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        .metric-card-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1em;
        }

        .metric-card-value {
            font-size: 2.5em;
            font-weight: 700;
            text-align: center;
            padding: 20px 0;
            color: var(--text-primary);
            line-height: 1;
        }

        .help-icon { 
            cursor: pointer; 
            color: var(--text-muted);
            font-size: 0.9em; 
            opacity: 0.7; 
            transition: opacity 0.2s; 
        }

        .help-icon:hover { 
            opacity: 1; 
            color: var(--text-secondary);
        }

        /* チャートコンテナ */
        .chart-container { 
            background: var(--bg-secondary);
            border-radius: 12px; 
            padding: 24px; 
            margin-top: 20px; 
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
        }

        .chart-container h3 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ローディング */
        .loading { 
            display: none; 
            text-align: center; 
            padding: 20px; 
            color: var(--text-secondary);
        }

        .spinner { 
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--positive-color);
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
            margin: 0 auto 12px; 
        }

        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* エラーメッセージ */
        .error-message { 
            background: rgba(255, 40, 0, 0.1);
            color: var(--negative-color);
            padding: 12px 16px; 
            border-radius: 8px; 
            margin-top: 16px; 
            display: none;
            border: 1px solid rgba(255, 40, 0, 0.2);
            font-size: 0.9em;
        }

        /* ポップアップ */
        .popup-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5);
            z-index: 1000; 
            display: none; 
            align-items: center; 
            justify-content: center; 
            padding: 20px;
        }

        .popup-content { 
            background: var(--card-bg);
            border-radius: 12px; 
            padding: 25px; 
            max-width: 400px; 
            margin: 20px; 
            border: 1px solid var(--border-color);
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }

        .popup-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }

        .popup-title { 
            font-size: 1.2em; 
            font-weight: 600; 
            color: var(--text-primary);
        }

        .popup-close { 
            cursor: pointer; 
            font-size: 1.5em; 
            color: var(--text-secondary);
            font-weight: bold; 
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .popup-close:hover { 
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .popup-body { 
            color: var(--text-secondary);
            line-height: 1.6; 
            font-size: 0.95em;
        }

        /* サイドパネル */
        .side-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1099;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .side-panel-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }

        .side-panel { 
            position: fixed; 
            top: 0; 
            right: -600px; 
            width: 600px; 
            height: 100vh; 
            background: var(--bg-secondary);
            z-index: 1100; 
            transition: right 0.3s ease; 
            overflow-y: auto; 
            border-left: 1px solid var(--border-color);
            box-shadow: -10px 0 30px rgba(0,0,0,0.2);
        }

        .side-panel.open { 
            right: 0; 
        }

        .side-panel-header { 
            padding: 20px; 
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
        }

        .side-panel-title { 
            font-size: 1.3em; 
            font-weight: 600; 
            color: var(--text-primary);
        }

        .side-panel-close { 
            cursor: pointer; 
            font-size: 1.8em; 
            color: var(--text-secondary);
            font-weight: bold; 
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .side-panel-close:hover { 
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .side-panel-content { 
            padding: 20px; 
        }

        .drill-section { 
            margin-bottom: 30px; 
        }

        .drill-section h3 { 
            color: var(--text-primary);
            margin-bottom: 15px; 
            font-size: 1.1em; 
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px; 
        }

        .drill-stats { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            margin-bottom: 20px; 
        }

        .drill-stat-item { 
            background: var(--bg-tertiary);
            padding: 16px; 
            border-radius: 8px; 
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .drill-stat-value { 
            font-size: 1.4em; 
            font-weight: 600; 
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .drill-stat-label { 
            font-size: 0.85em; 
            color: var(--text-secondary);
        }

        .drill-insights { 
            background: var(--bg-tertiary);
            border-left: 4px solid var(--positive-color);
            padding: 16px; 
            border-radius: 8px; 
            margin-top: 15px; 
            border: 1px solid var(--border-color);
        }

        .drill-insights h4 { 
            color: var(--text-primary);
            margin-bottom: 10px; 
            font-size: 1em; 
            font-weight: 600;
        }

        .drill-insights ul { 
            margin-left: 20px; 
        }

        .drill-insights li { 
            margin-bottom: 5px; 
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Canvas要素のスタイル */
        canvas {
            max-width: 100%;
            height: auto !important;
        }

        /* レスポンシブ */
        @media (max-width: 768px) {
            .container {
                padding: 20px 16px;
            }

            .style-performance-grid {
                grid-template-columns: 1fr;
            }
            
            .analysis-section {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.5em;
            }

            .theme-toggle {
                top: 10px;
                right: 10px;
                padding: 6px 10px;
            }

            .upload-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .side-panel {
                width: 100vw;
                right: -100vw;
            }
        }

        /* スクロールバー */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
    </style>
</head>
<body class="dark-mode">
    <div class="container">
        <header>
            <h1>②ポジション保有時間指数</h1>
            <p>ポジションをどのくらい保有し、効率的だったかを可視化＜UI開発＞</p>
            <button class="theme-toggle" onclick="toggleTheme()">
                <svg viewBox="0 0 24 24" id="theme-icon">
                    <path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>
                <span class="theme-toggle-text">ライトモード</span>
            </button>
        </header>

        <div class="upload-section">
            <h2>取引履歴ファイルをアップロード</h2>
            <div class="upload-controls">
                <div class="file-input-wrapper">
                    <input type="file" id="fileInput" accept=".html,.htm" />
                    <label for="fileInput">ファイルを選択</label>
                </div>
            </div>
            <div id="fileName"></div>
            <div id="fileInfo" class="file-info" style="display: none;">
                <h4>取引履歴情報</h4>
                <div id="tradePeriod"></div>
                <div id="tradeCount"></div>
            </div>
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>分析中...</p>
            </div>
            <div class="error-message" id="errorMessage"></div>
        </div>

        <div class="demo-controls">
            <h3>デモデータでテスト</h3>
            <button onclick="generateGoodPerformanceData()">優秀なトレーダーデータ</button>
            <button onclick="generateAveragePerformanceData()">平均的なトレーダーデータ</button>
            <button onclick="generatePoorPerformanceData()">改善が必要なトレーダーデータ</button>
        </div>

        <!-- 保有時間タイプフィルター -->
        <div class="trading-style-section" id="tradingStyleSection" style="display: none;">
            <div class="trading-style-header">
                <span class="section-icon">⏱️</span>
                トレードスタイル別分析
            </div>
            <!-- トレードスタイル可視化 -->
            <div class="trading-style-viz">
                <div class="style-viz-container">
                    <canvas id="styleDistributionChart" height="300"></canvas>
                </div>
                <div class="style-performance-grid">
                    <div class="style-perf-card" id="perfScalping">
                        <div class="style-perf-header">
                            <span class="style-perf-title">スキャルピング</span>
                            <span class="style-perf-time">〜30分</span>
                        </div>
                        <div class="style-perf-metrics">
                            <div class="style-perf-metric">
                                <span class="metric-label">取引数</span>
                                <span class="metric-value" id="countScalping">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">勝率</span>
                                <span class="metric-value" id="winRateScalping">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">期待値(EV)</span>
                                <span class="metric-value" id="evScalping">-</span>
                            </div>
                        </div>
                        <div class="style-perf-recommendation" id="recScalping"></div>
                    </div>
                    
                    <div class="style-perf-card" id="perfDay">
                        <div class="style-perf-header">
                            <span class="style-perf-title">デイトレード</span>
                            <span class="style-perf-time">30分〜4時間</span>
                        </div>
                        <div class="style-perf-metrics">
                            <div class="style-perf-metric">
                                <span class="metric-label">取引数</span>
                                <span class="metric-value" id="countDay">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">勝率</span>
                                <span class="metric-value" id="winRateDay">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">期待値(EV)</span>
                                <span class="metric-value" id="evDay">-</span>
                            </div>
                        </div>
                        <div class="style-perf-recommendation" id="recDay"></div>
                    </div>
                    
                    <div class="style-perf-card" id="perfSwing">
                        <div class="style-perf-header">
                            <span class="style-perf-title">スイング</span>
                            <span class="style-perf-time">4時間〜1日</span>
                        </div>
                        <div class="style-perf-metrics">
                            <div class="style-perf-metric">
                                <span class="metric-label">取引数</span>
                                <span class="metric-value" id="countSwing">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">勝率</span>
                                <span class="metric-value" id="winRateSwing">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">期待値(EV)</span>
                                <span class="metric-value" id="evSwing">-</span>
                            </div>
                        </div>
                        <div class="style-perf-recommendation" id="recSwing"></div>
                    </div>
                    
                    <div class="style-perf-card" id="perfPosition">
                        <div class="style-perf-header">
                            <span class="style-perf-title">ポジション</span>
                            <span class="style-perf-time">1日以上</span>
                        </div>
                        <div class="style-perf-metrics">
                            <div class="style-perf-metric">
                                <span class="metric-label">取引数</span>
                                <span class="metric-value" id="countPosition">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">勝率</span>
                                <span class="metric-value" id="winRatePosition">-</span>
                            </div>
                            <div class="style-perf-metric">
                                <span class="metric-label">期待値(EV)</span>
                                <span class="metric-value" id="evPosition">-</span>
                            </div>
                        </div>
                        <div class="style-perf-recommendation" id="recPosition"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- フィルターセクション -->
        <div class="filter-section" id="filterSection">
            <div class="filter-header">フィルター設定</div>
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="symbolFilter">通貨ペア</label>
                    <select id="symbolFilter">
                        <option value="all">すべての通貨ペア</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="positionFilter">ロング／ショート</label>
                    <select id="positionFilter">
                        <option value="all">すべてのポジション</option>
                        <option value="buy">ロング（買い）のみ</option>
                        <option value="sell">ショート（売り）のみ</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="weekdayFilter">曜日</label>
                    <select id="weekdayFilter">
                        <option value="all">すべての曜日</option>
                        <option value="1">月曜日</option>
                        <option value="2">火曜日</option>
                        <option value="3">水曜日</option>
                        <option value="4">木曜日</option>
                        <option value="5">金曜日</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="timeFilter">時間帯（日本時間）</label>
                    <select id="timeFilter">
                        <option value="all">すべての時間</option>
                        <option value="morning">朝（6:00-11:59）</option>
                        <option value="afternoon">昼（12:00-17:59）</option>
                        <option value="evening">夜（18:00-23:59）</option>
                        <option value="night">深夜（0:00-5:59）</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="resultFilter">勝敗</label>
                    <select id="resultFilter">
                        <option value="all">すべての取引</option>
                        <option value="win">勝ちトレードのみ</option>
                        <option value="loss">負けトレードのみ</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="analysisRoot"></div>
        
        <!-- ポップアップオーバーレイ -->
        <div class="popup-overlay" id="popupOverlay">
            <div class="popup-content">
                <div class="popup-header">
                    <div class="popup-title" id="popupTitle"></div>
                    <div class="popup-close" id="popupClose">&times;</div>
                </div>
                <div class="popup-body" id="popupBody"></div>
            </div>
        </div>
        
        <!-- サイドパネルオーバーレイ -->
        <div class="side-panel-overlay" id="sidePanelOverlay"></div>
        
        <!-- サイドパネル -->
        <div class="side-panel" id="sidePanel">
            <div class="side-panel-header">
                <div class="side-panel-title" id="sidePanelTitle">保有時間詳細分析</div>
                <div class="side-panel-close" id="sidePanelClose">&times;</div>
            </div>
            <div class="side-panel-content" id="sidePanelContent"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // 統一デモデータ（他カテゴリーと共通）
        const DEMO_TRADERS = {
            excellent: {
                name: "優秀なトレーダー",
                description: "勝率75%、高い期待値を持つトレーダーのデータ",
                kpi: {
                    totalTrades: 150,
                    winRate: 75.2,
                    totalProfit: 320000,
                    avgProfit: 12800,
                    avgLoss: -4200,
                    expectedValue: 2133,
                    profitFactor: 3.05
                },
                delta: { pf: 0.25, ev: 1200, wr: -2.1 },
                pareto: {
                    top: [45000, 38000, 32000, 28000, 25000],
                    bottom: [-8000, -6500, -5200, -4800, -4100]
                },
                streaks: {
                    win: [8, 6, 5, 4, 3],
                    lose: [2, 2, 1, 1, 1]
                }
            },
            average: {
                name: "平均的なトレーダー", 
                description: "勝率55%、標準的なパフォーマンスのトレーダーデータ",
                kpi: {
                    totalTrades: 120,
                    winRate: 55.8,
                    totalProfit: 45000,
                    avgProfit: 8500,
                    avgLoss: -6200,
                    expectedValue: 375,
                    profitFactor: 1.18
                },
                delta: { pf: -0.15, ev: -800, wr: 1.8 },
                pareto: {
                    top: [25000, 18000, 15000, 12000, 10500],
                    bottom: [-15000, -12000, -9500, -8200, -7100]
                },
                streaks: {
                    win: [5, 4, 3, 3, 2],
                    lose: [4, 3, 3, 2, 2]
                }
            },
            poor: {
                name: "改善が必要なトレーダー",
                description: "勝率38%、損失超過のトレーダーデータ", 
                kpi: {
                    totalTrades: 95,
                    winRate: 38.9,
                    totalProfit: -85000,
                    avgProfit: 6200,
                    avgLoss: -8900,
                    expectedValue: -895,
                    profitFactor: 0.65
                },
                delta: { pf: -0.45, ev: -2100, wr: -8.3 },
                pareto: {
                    top: [18000, 12000, 9500, 8200, 7100],
                    bottom: [-25000, -18000, -15000, -12000, -10500]
                },
                streaks: {
                    win: [3, 2, 2, 1, 1],
                    lose: [7, 5, 4, 4, 3]
                }
            }
        };

        // 派生値計算用のヘルパー関数
        const CALCULATIONS = {
            getWinTrades: (data) => Math.round(data.kpi.totalTrades * data.kpi.winRate / 100),
            getLossTrades: (data) => Math.round(data.kpi.totalTrades * (100 - data.kpi.winRate) / 100),
            getTotalWinAmount: (data) => Math.round(CALCULATIONS.getWinTrades(data) * data.kpi.avgProfit),
            getTotalLossAmount: (data) => Math.round(Math.abs(CALCULATIONS.getLossTrades(data) * data.kpi.avgLoss))
        };

        // 保有時間ベースのトレードデータ生成
        function generateHoldingTimeBasedTrades(traderData) {
            const totalTrades = traderData.kpi.totalTrades;
            const winRate = traderData.kpi.winRate / 100;
            const trades = [];
            const symbols = ['USDJPY', 'EURUSD', 'GBPUSD', 'EURJPY', 'GBPJPY'];
            const baseDate = new Date(2024, 0, 1);
            
            for (let i = 0; i < totalTrades; i++) {
                const openTime = new Date(baseDate.getTime() + Math.random() * 90 * 24 * 60 * 60 * 1000);
                
                // トレーダータイプに応じた保有時間生成
                let duration;
                if (traderData === DEMO_TRADERS.excellent) {
                    // 優秀: 短時間取引が多い（スキャルピング〜デイトレード中心）
                    duration = Math.random() < 0.6 ? 
                        Math.random() * 14400000 : // 4時間以内が60%
                        Math.random() * 86400000;   // 24時間以内が40%
                } else if (traderData === DEMO_TRADERS.average) {
                    // 平均: バランス良く
                    duration = Math.random() * 172800000; // 48時間以内
                } else {
                    // 改善必要: 長時間保有が多い（損切りが遅い）
                    duration = Math.random() < 0.4 ? 
                        Math.random() * 43200000 :  // 12時間以内が40%
                        Math.random() * 259200000;  // 72時間以内が60%
                }
                
                const closeTime = new Date(openTime.getTime() + duration);
                const isWin = Math.random() < winRate;
                
                let profit;
                if (isWin) {
                    profit = traderData.kpi.avgProfit * (0.5 + Math.random());
                } else {
                    profit = traderData.kpi.avgLoss * (0.5 + Math.random());
                }
                
                trades.push({
                    ticket: `#${(traderData === DEMO_TRADERS.excellent ? 200000 : 
                              traderData === DEMO_TRADERS.average ? 300000 : 400000) + i}`,
                    openTime: openTime,
                    closeTime: closeTime,
                    type: Math.random() > 0.5 ? 'buy' : 'sell',
                    size: 0.1,
                    symbol: symbols[Math.floor(Math.random() * symbols.length)],
                    profit: Math.round(profit),
                    isWin: isWin,
                    duration: duration
                });
            }
            
            return trades.sort((a, b) => a.openTime.getTime() - b.openTime.getTime());
        }

        // グローバル変数
        let allTrades = [];
        let filteredTrades = [];
        let activeCharts = [];

        // DOM要素の取得
        const fileInput = document.getElementById('fileInput');
        const fileNameEl = document.getElementById('fileName');
        const fileInfoEl = document.getElementById('fileInfo');
        const tradePeriodEl = document.getElementById('tradePeriod');
        const tradeCountEl = document.getElementById('tradeCount');
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('errorMessage');
        const analysisRootEl = document.getElementById('analysisRoot');
        const filterSectionEl = document.getElementById('filterSection');
        const tradingStyleSectionEl = document.getElementById('tradingStyleSection');
        const symbolFilterEl = document.getElementById('symbolFilter');
        const positionFilterEl = document.getElementById('positionFilter');
        const weekdayFilterEl = document.getElementById('weekdayFilter');
        const timeFilterEl = document.getElementById('timeFilter');
        const resultFilterEl = document.getElementById('resultFilter');
        const popupOverlay = document.getElementById('popupOverlay');
        const popupTitle = document.getElementById('popupTitle');
        const popupBody = document.getElementById('popupBody');
        const popupClose = document.getElementById('popupClose');
        const sidePanel = document.getElementById('sidePanel');
        const sidePanelTitle = document.getElementById('sidePanelTitle');
        const sidePanelContent = document.getElementById('sidePanelContent');
        const sidePanelClose = document.getElementById('sidePanelClose');
        const sidePanelOverlay = document.getElementById('sidePanelOverlay');

        // ヘルプ説明文
        const helpTexts = {
            '総取引数': '分析対象期間内に実行された売買取引の総回数です。',
            '勝率': '利益を出したトレードの割合です。50%以上が目安です。',
            '総損益': '全取引の損益合計です。プラスなら利益、マイナスなら損失です。',
            '勝ちトレード平均保有時間': '利益を出したポジションの平均保有期間です。',
            '負けトレード平均保有時間': '損失を出したポジションの平均保有期間です。',
            '最長保有時間（勝ち）': '勝ちトレードの中で最も長く保有した時間です。',
            '最短保有時間（勝ち）': '勝ちトレードの中で最も短く保有した時間です。',
            '最長保有時間（負け）': '負けトレードの中で最も長く保有した時間です。',
            '最短保有時間（負け）': '負けトレードの中で最も短く保有した時間です。',
            '保有時間分布': '保有時間別の取引回数を表示します。勝ち負け別に色分けされています。'
        };

        // テーマ管理
        function initTheme() {
            document.body.classList.add('dark-mode');
            updateThemeButton('dark');
            updateChartDefaults('dark');
        }
        
        window.toggleTheme = function() {
            const isDark = document.body.classList.contains('dark-mode');
            const newTheme = isDark ? 'light' : 'dark';
            
            if (newTheme === 'dark') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            
            updateThemeButton(newTheme);
            updateChartDefaults(newTheme);
            
            if (filteredTrades && filteredTrades.length > 0) {
                renderAnalysis(filteredTrades);
                updateTradingStyleCounts();
            }
        };
        
        function updateThemeButton(theme) {
            const icon = document.getElementById('theme-icon');
            const text = document.querySelector('.theme-toggle-text');
            
            if (theme === 'dark') {
                icon.innerHTML = '<path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>';
                text.textContent = 'ライトモード';
            } else {
                icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
                text.textContent = 'ダークモード';
            }
        }
        
        function updateChartDefaults(theme) {
            if (typeof Chart !== 'undefined') {
                if (theme === 'dark') {
                    Chart.defaults.color = '#aaa';
                    Chart.defaults.borderColor = '#373737';
                    Chart.defaults.plugins.legend.labels.color = '#aaa';
                } else {
                    Chart.defaults.color = '#666';
                    Chart.defaults.borderColor = '#ebebeb';
                    Chart.defaults.plugins.legend.labels.color = '#666';
                }
            }
        }

        // イベントリスナー
        document.addEventListener('DOMContentLoaded', initTheme);
        fileInput.addEventListener('change', handleFileUpload);
        symbolFilterEl.addEventListener('change', applyFilters);
        positionFilterEl.addEventListener('change', applyFilters);
        weekdayFilterEl.addEventListener('change', applyFilters);
        timeFilterEl.addEventListener('change', applyFilters);
        resultFilterEl.addEventListener('change', applyFilters);
        popupClose.addEventListener('click', closePopup);
        popupOverlay.addEventListener('click', (e) => {
            if (e.target === popupOverlay) closePopup();
        });
        sidePanelClose.addEventListener('click', closeSidePanel);
        sidePanelOverlay.addEventListener('click', closeSidePanel);

        // グローバル関数
        window.showHelp = function(title) {
            popupTitle.textContent = title;
            popupBody.textContent = helpTexts[title] || '説明が見つかりません。';
            popupOverlay.style.display = 'flex';
        };

        // デモデータ生成関数（統一データを使用）
        window.generateGoodPerformanceData = function() {
            console.log('Loading good performance demo data...');
            setLoading(true);
            
            const traderData = DEMO_TRADERS.excellent;
            allTrades = generateHoldingTimeBasedTrades(traderData);
            filteredTrades = [...allTrades];
            
            fileNameEl.textContent = 'デモデータ（優秀なトレーダー）を使用中';
            displayFileInfo(allTrades);
            populateFilters();
            updateTradingStyleCounts();
            filterSectionEl.style.display = 'block';
            tradingStyleSectionEl.style.display = 'block';
            renderAnalysis(filteredTrades);
            setLoading(false);
        };

        window.generateAveragePerformanceData = function() {
            console.log('Loading average performance demo data...');
            setLoading(true);
            
            const traderData = DEMO_TRADERS.average;
            allTrades = generateHoldingTimeBasedTrades(traderData);
            filteredTrades = [...allTrades];
            
            fileNameEl.textContent = 'デモデータ（平均的なトレーダー）を使用中';
            displayFileInfo(allTrades);
            populateFilters();
            updateTradingStyleCounts();
            filterSectionEl.style.display = 'block';
            tradingStyleSectionEl.style.display = 'block';
            renderAnalysis(filteredTrades);
            setLoading(false);
        };

        window.generatePoorPerformanceData = function() {
            console.log('Loading poor performance demo data...');
            setLoading(true);
            
            const traderData = DEMO_TRADERS.poor;
            allTrades = generateHoldingTimeBasedTrades(traderData);
            filteredTrades = [...allTrades];
            
            fileNameEl.textContent = 'デモデータ（改善が必要なトレーダー）を使用中';
            displayFileInfo(allTrades);
            populateFilters();
            updateTradingStyleCounts();
            filterSectionEl.style.display = 'block';
            tradingStyleSectionEl.style.display = 'block';
            renderAnalysis(filteredTrades);
            setLoading(false);
        };

        // トレードスタイル判定
        function getTradingStyle(duration) {
            const minutes = duration / (1000 * 60);
            const hours = duration / (1000 * 60 * 60);
            
            if (minutes <= 30) return 'scalping';
            if (hours <= 4) return 'day';
            if (hours <= 24) return 'swing';
            return 'position';
        }

        // トレードスタイル分析
        function updateTradingStyleCounts() {
            const styleCounts = {
                all: allTrades.length,
                scalping: 0,
                day: 0,
                swing: 0,
                position: 0
            };
            
            const styleStats = {
                scalping: { wins: 0, losses: 0, profit: 0 },
                day: { wins: 0, losses: 0, profit: 0 },
                swing: { wins: 0, losses: 0, profit: 0 },
                position: { wins: 0, losses: 0, profit: 0 }
            };
            
            allTrades.forEach(trade => {
                const style = getTradingStyle(trade.duration);
                styleCounts[style]++;
                
                if (trade.isWin) {
                    styleStats[style].wins++;
                } else {
                    styleStats[style].losses++;
                }
                styleStats[style].profit += trade.profit;
            });
            
            updatePerformanceCards(styleCounts, styleStats);
            createStyleComparisonChart(styleCounts, styleStats);
        }

        function updatePerformanceCards(styleCounts, styleStats) {
            const styles = ['scalping', 'day', 'swing', 'position'];
            
            styles.forEach(style => {
                const count = styleCounts[style];
                const stats = styleStats[style];
                
                const countEl = document.getElementById(`count${style.charAt(0).toUpperCase() + style.slice(1)}`);
                const winRateEl = document.getElementById(`winRate${style.charAt(0).toUpperCase() + style.slice(1)}`);
                const evEl = document.getElementById(`ev${style.charAt(0).toUpperCase() + style.slice(1)}`);
                const recEl = document.getElementById(`rec${style.charAt(0).toUpperCase() + style.slice(1)}`);
                
                if (countEl) {
                    countEl.textContent = `${count}回`;
                    countEl.className = 'metric-value neutral';
                }
                
                if (winRateEl) {
                    if (count > 0) {
                        const winRate = (stats.wins / count * 100).toFixed(1);
                        winRateEl.textContent = `${winRate}%`;
                        winRateEl.className = `metric-value ${winRate >= 55 ? 'positive' : winRate >= 45 ? 'neutral' : 'negative'}`;
                    } else {
                        winRateEl.textContent = '-';
                        winRateEl.className = 'metric-value neutral';
                    }
                }
                
                if (evEl) {
                    if (count > 0) {
                        const ev = stats.profit / count;
                        evEl.textContent = `¥${Math.round(ev).toLocaleString()}`;
                        evEl.className = `metric-value ${ev > 0 ? 'positive' : 'negative'}`;
                    } else {
                        evEl.textContent = '-';
                        evEl.className = 'metric-value neutral';
                    }
                }
                
                if (recEl) {
                    if (count > 0) {
                        const winRate = stats.wins / count;
                        const ev = stats.profit / count;
                        
                        if (ev > 1000 && winRate >= 0.6) {
                            recEl.textContent = '優秀！このスタイルが最適です';
                            recEl.className = 'style-perf-recommendation excellent';
                        } else if (ev > 0 && winRate >= 0.5) {
                            recEl.textContent = '良好。継続して改善しましょう';
                            recEl.className = 'style-perf-recommendation';
                        } else if (ev < 0 && count < 10) {
                            recEl.textContent = 'サンプル数が少ないため評価困難';
                            recEl.className = 'style-perf-recommendation warning';
                        } else if (ev < 0) {
                            recEl.textContent = '改善が必要。ルールの見直しを';
                            recEl.className = 'style-perf-recommendation danger';
                        } else {
                            recEl.textContent = 'さらなる検証が必要です';
                            recEl.className = 'style-perf-recommendation';
                        }
                    } else {
                        recEl.textContent = 'データなし';
                        recEl.className = 'style-perf-recommendation';
                    }
                }
            });
        }

        function createStyleComparisonChart(styleCounts, styleStats) {
            const ctx = document.getElementById('styleDistributionChart');
            if (!ctx) return;
            
            const existingChart = Chart.getChart(ctx);
            if (existingChart) {
                existingChart.destroy();
            }
            
            const labels = ['スキャルピング', 'デイトレード', 'スイング', 'ポジション'];
            const styles = ['scalping', 'day', 'swing', 'position'];
            
            const winData = styles.map(style => styleStats[style].wins);
            const lossData = styles.map(style => styleStats[style].losses);
            const winRates = styles.map(style => {
                const total = styleStats[style].wins + styleStats[style].losses;
                return total > 0 ? (styleStats[style].wins / total * 100) : 0;
            });
            
            const isDark = document.body.classList.contains('dark-mode');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '勝ちトレード',
                            data: winData,
                            backgroundColor: isDark ? 'rgba(0, 200, 255, 0.8)' : 'rgba(0, 126, 255, 0.8)',
                            borderColor: isDark ? '#00c8ff' : '#007eff',
                            borderWidth: 1,
                            stack: 'Stack 0'
                        },
                        {
                            label: '負けトレード',
                            data: lossData,
                            backgroundColor: isDark ? 'rgba(255, 50, 0, 0.8)' : 'rgba(255, 40, 0, 0.8)',
                            borderColor: isDark ? '#ff3200' : '#ff2800',
                            borderWidth: 1,
                            stack: 'Stack 0'
                        },
                        {
                            label: '勝率 (%)',
                            data: winRates,
                            type: 'line',
                            borderColor: isDark ? '#00c8ff' : '#007eff',
                            backgroundColor: isDark ? 'rgba(0, 200, 255, 0.1)' : 'rgba(0, 126, 255, 0.1)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointBackgroundColor: isDark ? '#00c8ff' : '#007eff',
                            yAxisID: 'y1',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'トレードスタイル別パフォーマンス分析',
                            font: { size: 14, weight: 'bold' },
                            color: isDark ? '#e0e0e0' : '#333',
                            padding: { bottom: 20 }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 11 },
                                color: isDark ? '#aaa' : '#666'
                            }
                        },
                        tooltip: {
                            backgroundColor: isDark ? '#181818' : '#fafafa',
                            borderColor: isDark ? '#373737' : '#ebebeb',
                            borderWidth: 1,
                            titleColor: isDark ? '#e0e0e0' : '#333',
                            bodyColor: isDark ? '#aaa' : '#666'
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'トレードスタイル', color: isDark ? '#aaa' : '#666' },
                            grid: { color: isDark ? '#373737' : '#ebebeb' },
                            ticks: { color: isDark ? '#aaa' : '#666' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: '取引回数', color: isDark ? '#aaa' : '#666' },
                            beginAtZero: true,
                            grid: { color: isDark ? '#373737' : '#ebebeb' },
                            ticks: { color: isDark ? '#aaa' : '#666' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: '勝率 (%)', color: isDark ? '#aaa' : '#666' },
                            min: 0,
                            max: 100,
                            grid: { drawOnChartArea: false },
                            ticks: { color: isDark ? '#aaa' : '#666' }
                        }
                    }
                }
            });
        }

        function populateFilters() {
            const symbols = [...new Set(allTrades.map(t => t.symbol))];
            symbolFilterEl.innerHTML = '<option value="all">すべての通貨ペア</option>';
            symbols.sort().forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                symbolFilterEl.appendChild(option);
            });
        }

        function applyFilters() {
            if (!allTrades || allTrades.length === 0) return;
            
            filteredTrades = [...allTrades];
            
            const symbol = symbolFilterEl.value;
            if (symbol !== 'all') {
                filteredTrades = filteredTrades.filter(t => t.symbol === symbol);
            }
            
            const position = positionFilterEl.value;
            if (position !== 'all') {
                filteredTrades = filteredTrades.filter(t => t.type === position);
            }
            
            const weekday = weekdayFilterEl.value;
            if (weekday !== 'all') {
                filteredTrades = filteredTrades.filter(t => t.openTime.getDay() === parseInt(weekday));
            }
            
            const timeRange = timeFilterEl.value;
            if (timeRange !== 'all') {
                filteredTrades = filteredTrades.filter(t => {
                    const hour = t.openTime.getHours();
                    switch(timeRange) {
                        case 'morning': return hour >= 6 && hour < 12;
                        case 'afternoon': return hour >= 12 && hour < 18;
                        case 'evening': return hour >= 18 && hour < 24;
                        case 'night': return hour >= 0 && hour < 6;
                        default: return true;
                    }
                });
            }
            
            const result = resultFilterEl.value;
            if (result === 'win') {
                filteredTrades = filteredTrades.filter(t => t.isWin);
            } else if (result === 'loss') {
                filteredTrades = filteredTrades.filter(t => !t.isWin);
            }
            
            renderAnalysis(filteredTrades);
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            resetAnalysisView();
            fileNameEl.textContent = `選択されたファイル: ${file.name}`;
            setLoading(true);

            const reader = new FileReader();
            reader.onload = (e) => parseMT4History(e.target.result);
            reader.readAsText(file, 'UTF-8');
        }

        function parseMT4History(htmlContent) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');
                const tables = doc.querySelectorAll('table');
                let parsedTrades = [];
                
                tables.forEach(table => {
                    parsedTrades = parsedTrades.concat(parseTableData(table));
                });
                
                if (parsedTrades && parsedTrades.length > 0) {
                    allTrades = parsedTrades.map(trade => ({
                        ...trade,
                        duration: trade.closeTime.getTime() - trade.openTime.getTime()
                    })).sort((a, b) => a.openTime.getTime() - b.openTime.getTime());
                    
                    filteredTrades = [...allTrades];
                    displayFileInfo(allTrades);
                    populateFilters();
                    updateTradingStyleCounts();
                    filterSectionEl.style.display = 'block';
                    tradingStyleSectionEl.style.display = 'block';
                    renderAnalysis(filteredTrades);
                } else {
                    showError('ファイルから取引データが見つかりませんでした。');
                }
            } catch (error) {
                console.error('Parse error:', error);
                showError('ファイルの解析中にエラーが発生しました: ' + error.message);
            } finally {
                setLoading(false);
            }
        }

        function parseTableData(table) {
            const rows = table.querySelectorAll('tr');
            const parsedTrades = [];
            let headerMapping = {};
            let dataStartIndex = -1;
            
            for (let i = 0; i < Math.min(10, rows.length); i++) {
                const cells = rows[i].querySelectorAll('td, th');
                if (cells.length < 10) continue;
                
                const cellTexts = Array.from(cells).map(cell => cell.textContent.trim().toLowerCase());
                
                if (cellTexts.some(text => text.includes('ticket')) && 
                    cellTexts.some(text => text.includes('time')) && 
                    cellTexts.some(text => text.includes('type'))) {
                    
                    cellTexts.forEach((text, idx) => {
                        if (text.includes('ticket')) headerMapping.ticket = idx;
                        if (text.includes('open time')) headerMapping.openTime = idx;
                        if (text.includes('type')) headerMapping.type = idx;
                        if (text.includes('size') || text.includes('volume')) headerMapping.size = idx;
                        if (text.includes('item') || text.includes('symbol')) headerMapping.symbol = idx;
                        if (text.includes('price') && !headerMapping.openPrice) headerMapping.openPrice = idx;
                        if (text.includes('close time')) headerMapping.closeTime = idx;
                        if (text.includes('profit')) headerMapping.profit = idx;
                    });
                    dataStartIndex = i + 1;
                    break;
                }
            }
            
            if (dataStartIndex === -1) return [];
            
            for (let i = dataStartIndex; i < rows.length; i++) {
                const cells = rows[i].querySelectorAll('td');
                if (cells.length < 10) continue;
                
                const cellTexts = Array.from(cells).map(cell => cell.textContent.trim());
                const type = (cellTexts[headerMapping.type] || '').toLowerCase();
                
                if (type !== 'buy' && type !== 'sell') continue;
                if (!/^\d+$/.test(cellTexts[headerMapping.ticket])) continue;
                
                let profit = 0;
                const profitIndex = headerMapping.profit !== undefined ? headerMapping.profit : cells.length - 1;
                if (cellTexts[profitIndex]) {
                    profit = parseFloat(cellTexts[profitIndex].replace(/[^0-9\.-]/g, ''));
                }
                
                if (isNaN(profit)) continue;
                
                const openTime = parseDateTime(cellTexts[headerMapping.openTime]);
                const closeTime = parseDateTime(cellTexts[headerMapping.closeTime]);
                
                if (!openTime || !closeTime) continue;
                
                parsedTrades.push({
                    ticket: cellTexts[headerMapping.ticket],
                    openTime,
                    closeTime,
                    type,
                    size: parseFloat(cellTexts[headerMapping.size] || '0'),
                    symbol: cellTexts[headerMapping.symbol],
                    profit,
                    isWin: profit > 0
                });
            }
            
            return parsedTrades;
        }

        function parseDateTime(dateStr) {
            if (!dateStr) return null;
            const match = dateStr.match(/(\d{4})[./](\d{2})[./](\d{2})\s+(\d{2}):(\d{2})/);
            if (match) {
                const [, year, month, day, hour, minute] = match.map(Number);
                const d = new Date(year, month - 1, day, hour, minute);
                if (!isNaN(d.getTime())) return d;
            }
            return null;
        }

        function displayFileInfo(trades) {
            if (trades.length === 0) return;
            
            const startDate = new Date(Math.min(...trades.map(t => t.openTime.getTime())));
            const endDate = new Date(Math.max(...trades.map(t => t.closeTime.getTime())));
            
            const formatDate = (date) => {
                return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
            };
            
            tradePeriodEl.textContent = `期間: ${formatDate(startDate)} 〜 ${formatDate(endDate)}`;
            tradeCountEl.textContent = `総取引数: ${trades.length}回`;
            fileInfoEl.style.display = 'block';
        }

        function renderAnalysis(trades) {
            resetAnalysisView(true);
            
            if (!trades || trades.length === 0) {
                showError("選択された条件に一致する取引データがありません。");
                return;
            }

            const stats = calculateStatistics(trades);
            
            analysisRootEl.innerHTML = `
                <div class="analysis-section">
                    <div class="metric-card">
                        <div class="metric-card-header">
                            <span class="metric-card-title">勝ちトレード平均保有時間</span>
                            <span class="help-icon" onclick="showHelp('勝ちトレード平均保有時間')">?</span>
                        </div>
                        <div class="metric-card-value neutral">${formatDuration(stats.avgWinDuration)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-card-header">
                            <span class="metric-card-title">負けトレード平均保有時間</span>
                            <span class="help-icon" onclick="showHelp('負けトレード平均保有時間')">?</span>
                        </div>
                        <div class="metric-card-value neutral">${formatDuration(stats.avgLossDuration)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-card-header">
                            <span class="metric-card-title">最長保有時間（勝ち）</span>
                            <span class="help-icon" onclick="showHelp('最長保有時間（勝ち）')">?</span>
                        </div>
                        <div class="metric-card-value neutral">${formatDuration(stats.maxWinDuration)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-card-header">
                            <span class="metric-card-title">最短保有時間（勝ち）</span>
                            <span class="help-icon" onclick="showHelp('最短保有時間（勝ち）')">?</span>
                        </div>
                        <div class="metric-card-value neutral">${formatDuration(stats.minWinDuration)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-card-header">
                            <span class="metric-card-title">最長保有時間（負け）</span>
                            <span class="help-icon" onclick="showHelp('最長保有時間（負け）')">?</span>
                        </div>
                        <div class="metric-card-value neutral">${formatDuration(stats.maxLossDuration)}</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-card-header">
                            <span class="metric-card-title">最短保有時間（負け）</span>
                            <span class="help-icon" onclick="showHelp('最短保有時間（負け）')">?</span>
                        </div>
                        <div class="metric-card-value neutral">${formatDuration(stats.minLossDuration)}</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3>保有時間分布<span class="help-icon" onclick="showHelp('保有時間分布')">?</span></h3>
                    <canvas id="durationChart"></canvas>
                </div>
            `;
            
            createDurationChart(trades);
        }

        function calculateStatistics(trades) {
            const winTrades = trades.filter(t => t.isWin);
            const lossTrades = trades.filter(t => !t.isWin);
            
            const winDurations = winTrades.map(t => t.duration);
            const lossDurations = lossTrades.map(t => t.duration);
            
            const avgWinDuration = winDurations.length > 0 ? 
                winDurations.reduce((sum, d) => sum + d, 0) / winDurations.length : 0;
            const avgLossDuration = lossDurations.length > 0 ? 
                lossDurations.reduce((sum, d) => sum + d, 0) / lossDurations.length : 0;
            
            return {
                totalTrades: trades.length,
                avgWinDuration,
                avgLossDuration,
                maxWinDuration: winDurations.length > 0 ? Math.max(...winDurations) : 0,
                minWinDuration: winDurations.length > 0 ? Math.min(...winDurations) : 0,
                maxLossDuration: lossDurations.length > 0 ? Math.max(...lossDurations) : 0,
                minLossDuration: lossDurations.length > 0 ? Math.min(...lossDurations) : 0,
                winTrades: winTrades.length,
                lossTrades: lossTrades.length
            };
        }

        function formatDuration(milliseconds) {
            if (!milliseconds || milliseconds === 0) return '0分';
            
            const totalMinutes = Math.floor(milliseconds / (1000 * 60));
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const days = Math.floor(hours / 24);
            const remainingHours = hours % 24;
            
            if (days > 0) {
                return `${days}日${remainingHours}時間${minutes}分`;
            } else if (hours > 0) {
                return `${hours}時間${minutes}分`;
            } else {
                return `${minutes}分`;
            }
        }

        function createDurationChart(trades) {
            const ctx = document.getElementById('durationChart');
            if (!ctx) return;
            
            activeCharts.forEach(chart => chart.destroy());
            activeCharts = [];
            
            const ranges = [
                { min: 0, max: 30, label: '〜30分' },
                { min: 30, max: 60, label: '30分〜1時間' },
                { min: 60, max: 180, label: '1〜3時間' },
                { min: 180, max: 360, label: '3〜6時間' },
                { min: 360, max: 720, label: '6〜12時間' },
                { min: 720, max: 1440, label: '12〜24時間' },
                { min: 1440, max: 2880, label: '1〜2日' },
                { min: 2880, max: Infinity, label: '2日以上' }
            ];

            const winDistribution = ranges.map(range => {
                return trades.filter(t => {
                    const minutes = t.duration / 60000;
                    return t.isWin && minutes > range.min && minutes <= range.max;
                }).length;
            });
            
            const lossDistribution = ranges.map(range => {
                return trades.filter(t => {
                    const minutes = t.duration / 60000;
                    return !t.isWin && minutes > range.min && minutes <= range.max;
                }).length;
            });

            const isDark = document.body.classList.contains('dark-mode');

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ranges.map(r => r.label),
                    datasets: [
                        {
                            label: '勝ちトレード',
                            data: winDistribution,
                            backgroundColor: isDark ? 'rgba(0, 200, 255, 0.8)' : 'rgba(0, 126, 255, 0.8)',
                            borderColor: isDark ? '#00c8ff' : '#007eff',
                            borderWidth: 1
                        },
                        {
                            label: '負けトレード',
                            data: lossDistribution,
                            backgroundColor: isDark ? 'rgba(255, 50, 0, 0.8)' : 'rgba(255, 40, 0, 0.8)',
                            borderColor: isDark ? '#ff3200' : '#ff2800',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            showDurationDrillDown(ranges[index], trades);
                        }
                    },
                    plugins: {
                        tooltip: {
                            backgroundColor: isDark ? '#181818' : '#fafafa',
                            borderColor: isDark ? '#373737' : '#ebebeb',
                            borderWidth: 1,
                            titleColor: isDark ? '#e0e0e0' : '#333',
                            bodyColor: isDark ? '#aaa' : '#666',
                            callbacks: {
                                afterLabel: function(context) {
                                    return 'クリックで詳細を表示';
                                }
                            }
                        },
                        legend: {
                            labels: {
                                color: isDark ? '#aaa' : '#666'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: '保有時間', color: isDark ? '#aaa' : '#666' },
                            grid: { color: isDark ? '#373737' : '#ebebeb' },
                            ticks: { color: isDark ? '#aaa' : '#666' }
                        },
                        y: {
                            title: { display: true, text: '取引回数', color: isDark ? '#aaa' : '#666' },
                            beginAtZero: true,
                            grid: { color: isDark ? '#373737' : '#ebebeb' },
                            ticks: { color: isDark ? '#aaa' : '#666' }
                        }
                    }
                }
            });
            
            activeCharts.push(chart);
        }

        function showDurationDrillDown(range, trades) {
            const filteredRangeTrades = trades.filter(t => {
                const minutes = t.duration / 60000;
                return minutes > range.min && minutes <= range.max;
            });
            
            if (filteredRangeTrades.length === 0) {
                alert('この時間範囲にはデータがありません。');
                return;
            }
            
            const winTrades = filteredRangeTrades.filter(t => t.isWin);
            const lossTrades = filteredRangeTrades.filter(t => !t.isWin);
            const totalProfit = filteredRangeTrades.reduce((sum, t) => sum + t.profit, 0);
            const avgProfit = totalProfit / filteredRangeTrades.length;
            const winRate = (winTrades.length / filteredRangeTrades.length * 100).toFixed(1);
            
            sidePanelTitle.textContent = `保有時間 ${range.label} の詳細分析`;
            
            sidePanelContent.innerHTML = `
                <div class="drill-section">
                    <h3>基本統計</h3>
                    <div class="drill-stats">
                        <div class="drill-stat-item">
                            <div class="drill-stat-value">${filteredRangeTrades.length}回</div>
                            <div class="drill-stat-label">総取引数</div>
                        </div>
                        <div class="drill-stat-item">
                            <div class="drill-stat-value ${winRate >= 50 ? 'positive' : 'negative'}">${winRate}%</div>
                            <div class="drill-stat-label">勝率</div>
                        </div>
                        <div class="drill-stat-item">
                            <div class="drill-stat-value ${totalProfit >= 0 ? 'positive' : 'negative'}">¥${Math.round(totalProfit).toLocaleString()}</div>
                            <div class="drill-stat-label">総損益</div>
                        </div>
                        <div class="drill-stat-item">
                            <div class="drill-stat-value ${avgProfit >= 0 ? 'positive' : 'negative'}">¥${Math.round(avgProfit).toLocaleString()}</div>
                            <div class="drill-stat-label">平均損益</div>
                        </div>
                    </div>
                </div>
                
                <div class="drill-section">
                    <h3>勝ちトレード統計</h3>
                    <div class="drill-stats">
                        <div class="drill-stat-item">
                            <div class="drill-stat-value neutral">${winTrades.length}回</div>
                            <div class="drill-stat-label">取引回数</div>
                        </div>
                        <div class="drill-stat-item">
                            <div class="drill-stat-value positive">¥${winTrades.length > 0 ? Math.round(winTrades.reduce((sum, t) => sum + t.profit, 0) / winTrades.length).toLocaleString() : 0}</div>
                            <div class="drill-stat-label">平均利益</div>
                        </div>
                    </div>
                </div>
                
                <div class="drill-section">
                    <h3>負けトレード統計</h3>
                    <div class="drill-stats">
                        <div class="drill-stat-item">
                            <div class="drill-stat-value neutral">${lossTrades.length}回</div>
                            <div class="drill-stat-label">取引回数</div>
                        </div>
                        <div class="drill-stat-item">
                            <div class="drill-stat-value negative">¥${lossTrades.length > 0 ? Math.abs(Math.round(lossTrades.reduce((sum, t) => sum + t.profit, 0) / lossTrades.length)).toLocaleString() : 0}</div>
                            <div class="drill-stat-label">平均損失</div>
                        </div>
                    </div>
                </div>
                
                <div class="drill-section">
                    <h3>分析と推奨事項</h3>
                    <div class="drill-insights">
                        <h4>パフォーマンス評価</h4>
                        <ul>
                            ${generateInsights(range, winRate, avgProfit, filteredRangeTrades)}
                        </ul>
                    </div>
                </div>
            `;
            
            sidePanel.classList.add('open');
            sidePanelOverlay.classList.add('open');
        }

        function generateInsights(range, winRate, avgProfit, trades) {
            let insights = [];
            
            if (range.max <= 60) {
                insights.push('<li>この時間帯はスキャルピング取引に該当します。</li>');
                if (parseFloat(winRate) >= 60) {
                    insights.push('<li>高い勝率を維持できています。短期売買戦略が機能しています。</li>');
                } else {
                    insights.push('<li>勝率向上のため、エントリーポイントの精度を高める必要があります。</li>');
                }
            } else if (range.max <= 720) {
                insights.push('<li>この時間帯はデイトレードに該当します。</li>');
                if (avgProfit > 0) {
                    insights.push('<li>日中の値動きを効果的に捉えています。</li>');
                } else {
                    insights.push('<li>損切りタイミングの見直しが必要かもしれません。</li>');
                }
            } else {
                insights.push('<li>この時間帯はスイング/ポジショントレードに該当します。</li>');
                if (avgProfit > 0) {
                    insights.push('<li>長期保有戦略が利益を生んでいます。</li>');
                } else {
                    insights.push('<li>長期保有のリスク管理を強化する必要があります。</li>');
                }
            }
            
            const winTrades = trades.filter(t => t.isWin);
            const lossTrades = trades.filter(t => !t.isWin);
            if (winTrades.length > 0 && lossTrades.length > 0) {
                const avgWin = winTrades.reduce((sum, t) => sum + t.profit, 0) / winTrades.length;
                const avgLoss = Math.abs(lossTrades.reduce((sum, t) => sum + t.profit, 0) / lossTrades.length);
                const riskReward = avgWin / avgLoss;
                
                if (riskReward > 1.5) {
                    insights.push('<li>優れたリスクリワード比を達成しています。</li>');
                } else if (riskReward > 1) {
                    insights.push('<li>リスクリワード比は良好です。</li>');
                } else {
                    insights.push('<li>リスクリワード比の改善が必要です。</li>');
                }
            }
            
            return insights.join('');
        }

        function closeSidePanel() {
            sidePanel.classList.remove('open');
            sidePanelOverlay.classList.remove('open');
        }

        function resetAnalysisView(keepFilters = false) {
            analysisRootEl.innerHTML = '';
            errorEl.style.display = 'none';
            
            if (!keepFilters) {
                fileInfoEl.style.display = 'none';
                filterSectionEl.style.display = 'none';
                tradingStyleSectionEl.style.display = 'none';
            }
            
            activeCharts.forEach(chart => chart.destroy());
            activeCharts = [];
        }

        function setLoading(isLoading) {
            loadingEl.style.display = isLoading ? 'block' : 'none';
        }

        function showError(message) {
            errorEl.style.display = 'block';
            errorEl.textContent = message;
        }

        function closePopup() {
            popupOverlay.style.display = 'none';
        }
    </script>
</body>
</html>
